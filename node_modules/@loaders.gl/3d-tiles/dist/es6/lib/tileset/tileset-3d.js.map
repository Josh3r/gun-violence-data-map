{"version":3,"sources":["../../../../src/lib/tileset/tileset-3d.js"],"names":["Matrix4","Vector3","Ellipsoid","Stats","path","assert","RequestScheduler","getFrameState","calculateTransformProps","Tile3DHeader","Tileset3DTraverser","Tileset3DCache","TILES_TOTAL","TILES_IN_MEMORY","TILES_IN_VIEW","TILES_RENDERABLE","TILES_LOADED","TILES_LOADING","TILES_UNLOADED","TILES_LOAD_FAILED","POINTS_COUNT","TILES_GPU_MEMORY","WGS84_RADIUS_X","WGS84_RADIUS_Y","WGS84_RADIUS_Z","scratchVector","getZoom","boundingVolume","halfAxes","radius","width","height","getColumn","x","len","y","z","zoomX","Math","log2","zoomY","zoomZ","DEFAULT_OPTIONS","basePath","ellipsoid","WGS84","modelMatrix","throttleRequests","maximumScreenSpaceError","maximumMemoryUsage","dynamicScreenSpaceError","dynamicScreenSpaceErrorDensity","dynamicScreenSpaceErrorFactor","skipLevelOfDetail","baseScreenSpaceError","onTileLoad","onTileUnload","onTileError","tile","message","url","getQueryParamString","queryParams","queryParamStrings","key","Object","keys","push","length","join","Tileset3D","constructor","json","options","dirname","stats","id","_initializeStats","gpuMemoryUsageInBytes","geometricError","undefined","userData","_queryParams","_requestScheduler","_traverser","_cache","_processingQueue","selectedTiles","_emptyTiles","_requestedTiles","_selectedTilesToStyle","asset","credits","description","_root","_properties","_extensionsUsed","_gltfUpAxis","_loadTimestamp","_timeSinceLoad","_updatedVisibilityFrame","_extras","_allTilesAdditive","_hasMixedContent","_maximumScreenSpaceError","_maximumMemoryUsage","_tilesLoaded","_initialTilesLoaded","_readyPromise","Promise","resolve","_classificationType","classificationType","_ellipsoid","_dynamicScreenSpaceErrorComputedDensity","_initializeTileSet","destroy","_destroy","traverser","properties","ready","Boolean","readyPromise","promise","tilesLoaded","root","boundingSphere","_checkReady","updateTransform","timeSinceLoad","value","extras","getTileUrl","tilePath","isDataUrl","startsWith","hasExtension","extensionName","indexOf","update","viewport","frameState","reset","traverse","values","requestedTiles","emptyTiles","_loadTile","_unloadTiles","tilesRenderable","pointsRenderable","contentAvailable","content","pointCount","get","count","frameNumber","trimLoadedTiles","trim","addTileToCache","add","tileset","tileToAdd","_addTileToCache","tilesetJson","Error","version","v","tilesetVersion","attributions","extensionsUsed","_initializeTileHeaders","_calculateViewProps","center","console","warn","cartographicCenter","zoom","cartesianToCartographic","cartesianCenter","parentTileHeader","rootTile","children","_depth","stack","pop","incrementCount","_header","childHeader","childTile","_destroyTileHeaders","parentTile","_destroySubtree","loaded","loadContent","error","decrementCount","toString","_content","byteLength","_unloadTile","unloadContent","unloadTiles","child","_destroyTile","unloadTile"],"mappings":"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","sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\nimport {Matrix4, Vector3} from 'math.gl';\nimport {Ellipsoid} from '@math.gl/geospatial';\nimport {Stats} from 'probe.gl';\nimport {path} from '@loaders.gl/core';\n\nimport assert from '../utils/assert';\nimport RequestScheduler from '../request-utils/request-scheduler';\nimport {getFrameState} from './helpers/get-frame-state';\n\nimport {calculateTransformProps} from './helpers/transform-utils';\nimport Tile3DHeader from './tile-3d-header';\nimport Tileset3DTraverser from './tileset-3d-traverser';\nimport Tileset3DCache from './tileset-3d-cache';\n\n// Tracked Stats\nconst TILES_TOTAL = 'Tiles In Tileset(s)';\nconst TILES_IN_MEMORY = 'Tiles In Memory';\nconst TILES_IN_VIEW = 'Tiles In View';\nconst TILES_RENDERABLE = 'Tiles To Render';\nconst TILES_LOADED = 'Tiles Loaded';\nconst TILES_LOADING = 'Tiles Loading';\nconst TILES_UNLOADED = 'Tiles Unloaded';\nconst TILES_LOAD_FAILED = 'Failed Tile Loads';\nconst POINTS_COUNT = 'Points';\nconst TILES_GPU_MEMORY = 'Tile Memory Use';\n\n// TODO move to Math library?\nconst WGS84_RADIUS_X = 6378137.0;\nconst WGS84_RADIUS_Y = 6378137.0;\nconst WGS84_RADIUS_Z = 6356752.3142451793;\n\nconst scratchVector = new Vector3();\n\nfunction getZoom(boundingVolume) {\n  const {halfAxes, radius, width, height} = boundingVolume;\n\n  if (halfAxes) {\n    // OrientedBoundingBox\n    halfAxes.getColumn(0, scratchVector);\n    const x = scratchVector.len();\n    halfAxes.getColumn(1, scratchVector);\n    const y = scratchVector.len();\n    halfAxes.getColumn(2, scratchVector);\n    const z = scratchVector.len();\n\n    const zoomX = Math.log2(WGS84_RADIUS_X / x / 2);\n    const zoomY = Math.log2(WGS84_RADIUS_Y / y / 2);\n    const zoomZ = Math.log2(WGS84_RADIUS_Z / z / 2);\n    return (zoomX + zoomY + zoomZ) / 3;\n  } else if (radius) {\n    // BoundingSphere\n    return Math.log2(WGS84_RADIUS_Z / radius);\n  } else if (height && width) {\n    // BoundingRectangle\n    const zoomX = Math.log2(WGS84_RADIUS_X / width);\n    const zoomY = Math.log2(WGS84_RADIUS_Y / height);\n\n    return (zoomX + zoomY) / 2;\n  }\n\n  return 18;\n}\n\nconst DEFAULT_OPTIONS = {\n  basePath: '',\n\n  ellipsoid: Ellipsoid.WGS84,\n  // A 4x4 transformation matrix this transforms the entire tileset.\n  modelMatrix: new Matrix4(),\n\n  // Set to true to enable experimental request throttling, for improved performance\n  throttleRequests: false,\n\n  // The maximum screen space error used to drive level of detail refinement.\n  maximumScreenSpaceError: 8,\n  maximumMemoryUsage: 32,\n\n  // default props\n  dynamicScreenSpaceError: false,\n  dynamicScreenSpaceErrorDensity: 0.00278,\n  dynamicScreenSpaceErrorFactor: 4.0,\n\n  // Optimization option. Determines if level of detail skipping should be applied during the traversal.\n  skipLevelOfDetail: false,\n  // The screen space error this must be reached before skipping levels of detail.\n  baseScreenSpaceError: 1024,\n\n  onTileLoad: () => {}, // Indicates this a tile's content was loaded\n  onTileUnload: () => {}, // Indicates this a tile's content was unloaded\n  onTileError: (tile, message, url) => {}\n};\n\nfunction getQueryParamString(queryParams) {\n  const queryParamStrings = [];\n  for (const key of Object.keys(queryParams)) {\n    queryParamStrings.push(`${key}=${queryParams[key]}`);\n  }\n  switch (queryParamStrings.length) {\n    case 0:\n      return '';\n    case 1:\n      return `?${queryParamStrings[0]}`;\n    default:\n      return `?${queryParamStrings.join('&')}`;\n  }\n}\n\nexport default class Tileset3D {\n  // eslint-disable-next-line max-statements\n  constructor(json, url, options = {}) {\n    assert(json);\n\n    // PUBLIC MEMBERS\n    this.options = {...DEFAULT_OPTIONS, ...options};\n    this.url = url; // The url to a tileset JSON file.\n    this.basePath = path.dirname(url); // base path that non-absolute paths in tileset are relative to.\n    this.modelMatrix = this.options.modelMatrix;\n    this.stats = new Stats({id: url});\n    this._initializeStats();\n\n    this.gpuMemoryUsageInBytes = 0; // The total amount of GPU memory in bytes used by the tileset.\n    this.geometricError = undefined; // Geometric error when the tree is not rendered at all\n    this.userData = {};\n\n    // HELPER OBJECTS\n    this._queryParams = {};\n    this._requestScheduler = new RequestScheduler({\n      throttleRequests: this.options.throttleRequests\n    });\n    this._traverser = new Tileset3DTraverser();\n    this._cache = new Tileset3DCache();\n\n    // HOLD TRAVERSAL RESULTS\n    this._processingQueue = [];\n    this.selectedTiles = [];\n    this._emptyTiles = [];\n    this._requestedTiles = [];\n    this._selectedTilesToStyle = [];\n\n    // Metadata for the entire tileset\n    this.asset = {};\n    this.credits = {};\n    this.description = this.options.description;\n\n    // EXTRACTED FROM TILESET\n    this._root = undefined;\n    this._properties = undefined; // Metadata for per-model/point/etc properties\n    this._extensionsUsed = undefined;\n    this._gltfUpAxis = undefined;\n\n    this._loadTimestamp = undefined;\n    this._timeSinceLoad = 0.0;\n    this._updatedVisibilityFrame = 0;\n    this._extras = undefined;\n\n    this._allTilesAdditive = true;\n    this._hasMixedContent = false;\n    this._maximumScreenSpaceError = this.options.maximumScreenSpaceError;\n    this._maximumMemoryUsage = this.options.maximumMemoryUsage;\n\n    this._tilesLoaded = false;\n    this._initialTilesLoaded = false;\n\n    this._readyPromise = Promise.resolve();\n\n    this._classificationType = this.options.classificationType;\n    this._ellipsoid = this.options.ellipsoid;\n\n    this._dynamicScreenSpaceErrorComputedDensity = 0.0; // Updated based on the camera position and direction\n\n    this._initializeTileSet(json, this.options);\n  }\n\n  destroy() {\n    this._destroy();\n  }\n\n  // Gets the tileset's asset object property, which contains metadata about the tileset.\n  // get asset() {\n  //   return this._asset;\n  // }\n  get traverser() {\n    return this._traverser;\n  }\n\n  // Gets the tileset's properties dictionary object, which contains metadata about per-feature properties.\n  get properties() {\n    return this._properties;\n  }\n\n  // When <code>true</code>, the tileset's root tile is loaded and the tileset is ready to render.\n  get ready() {\n    return Boolean(this._root);\n  }\n\n  // Gets the promise this will be resolved when the tileset's root tile is loaded and the tileset is ready to render.\n  // This promise is resolved at the end of the frame before the first frame the tileset is rendered in.\n  get readyPromise() {\n    return this._readyPromise.promise;\n  }\n\n  // When <code>true</code>, all tiles this meet the screen space error this frame are loaded.\n  get tilesLoaded() {\n    return this._tilesLoaded;\n  }\n\n  get queryParams() {\n    return getQueryParamString(this._queryParams);\n  }\n\n  // The root tile header.\n  get root() {\n    return this._root;\n  }\n\n  // The tileset's bounding sphere.\n  get boundingSphere() {\n    this._checkReady();\n    this._root.updateTransform(this.modelMatrix);\n    return this._root.boundingSphere;\n  }\n\n  // Returns the time, in milliseconds, since the tileset was loaded and first updated.\n  get timeSinceLoad() {\n    return this._timeSinceLoad;\n  }\n\n  // The maximum amount of GPU memory (in MB) that may be used to cache tiles.\n  // Tiles not in view are unloaded to enforce this.\n  get maximumMemoryUsage() {\n    return this._maximumMemoryUsage;\n  }\n\n  set maximumMemoryUsage(value) {\n    assert(value > 0);\n    this._maximumMemoryUsage = value;\n  }\n\n  // Gets an ellipsoid describing the shape of the globe.\n  get ellipsoid() {\n    return this.options.ellipsoid;\n  }\n\n  // Returns the extras property at the top of the tileset JSON (application specific metadata).\n  get extras() {\n    return this._extras;\n  }\n\n  getTileUrl(tilePath, basePath) {\n    const isDataUrl = url => url.startsWith('data:');\n    return isDataUrl(tilePath)\n      ? tilePath\n      : `${basePath || this.basePath}/${tilePath}${this.queryParams}`;\n  }\n\n  // true if the tileset JSON file lists the extension in extensionsUsed\n  hasExtension(extensionName) {\n    return Boolean(this._extensionsUsed && this._extensionsUsed.indexOf(extensionName) > -1);\n  }\n\n  update(viewport) {\n    let frameState;\n    if ('frameNumber' in viewport) {\n      // backward compatibility\n      // this is using old API, input is `frameState` object\n      // old API: update(frameState)\n      frameState = viewport;\n    } else {\n      // TODO deprecated in v8.x\n      frameState = getFrameState(viewport);\n    }\n\n    this._updatedVisibilityFrame++; // TODO: only update when camera or culling volume from last update moves (could be render camera change or prefetch camera)\n    this._cache.reset();\n\n    this._traverser.traverse(this.root, frameState, this.options);\n    this._requestedTiles = Object.values(this._traverser.requestedTiles);\n    this.selectedTiles = Object.values(this._traverser.selectedTiles);\n    this._emptyTiles = Object.values(this._traverser.emptyTiles);\n\n    const requestedTiles = this._requestedTiles;\n    // Sort requests by priority before making any requests.\n    // This makes it less likely this requests will be cancelled after being issued.\n    // requestedTiles.sort((a, b) => a._priority - b._priority);\n    for (const tile of requestedTiles) {\n      this._loadTile(tile, frameState);\n    }\n\n    this._unloadTiles();\n\n    let tilesRenderable = 0;\n    let pointsRenderable = 0;\n    for (const tile of this.selectedTiles) {\n      if (tile.contentAvailable) {\n        tilesRenderable++;\n        if (tile.content.pointCount) {\n          pointsRenderable += tile.content.pointCount;\n        }\n      }\n    }\n\n    this.stats.get(TILES_IN_VIEW).count = this.selectedTiles.length;\n    this.stats.get(TILES_RENDERABLE).count = tilesRenderable;\n    this.stats.get(POINTS_COUNT).count = pointsRenderable;\n\n    return frameState.frameNumber;\n  }\n\n  // TODO - why are these public methods? For testing?\n\n  // Unloads all tiles this weren't selected the previous frame.  This can be used to\n  trimLoadedTiles() {\n    this._cache.trim();\n  }\n\n  // Add to the tile cache. Previously expired tiles are already in the cache and won't get re-added.\n  addTileToCache(tile) {\n    this._cache.add(this, tile, (tileset, tileToAdd) => tileset._addTileToCache(tileToAdd));\n  }\n\n  // PRIVATE\n\n  // eslint-disable-next-line max-statements\n  _initializeTileSet(tilesetJson, options) {\n    this.asset = tilesetJson.asset;\n    if (!this.asset) {\n      throw new Error('Tileset must have an asset property.');\n    }\n    if (this.asset.version !== '0.0' && this.asset.version !== '1.0') {\n      throw new Error('The tileset must be 3D Tiles version 0.0 or 1.0.');\n    }\n\n    // Note: `asset.tilesetVersion` is version of the tileset itself (not the version of the 3D TILES standard)\n    // We add this version as a `v=1.0` query param to fetch the right version and not get an older cached version\n    if ('tilesetVersion' in this.asset) {\n      this._queryParams.v = this.asset.tilesetVersion;\n    }\n\n    // TODO - ion resources have a credits property we can use for additional attribution.\n    this.credits = {\n      attributions: options.attributions || []\n    };\n\n    this._properties = tilesetJson.properties;\n    this.geometricError = tilesetJson.geometricError;\n    this._extensionsUsed = tilesetJson.extensionsUsed;\n    this._extras = tilesetJson.extras;\n\n    // TODO - handle configurable glTF up axis\n    // const gltfUpAxis = defined(tilesetJson.asset.gltfUpAxis)\n    //   ? Axis.fromName(tilesetJson.asset.gltfUpAxis)\n    //   : Axis.Y;\n\n    this._root = this._initializeTileHeaders(tilesetJson, null, this.basePath);\n\n    // Calculate cartographicCenter & zoom props to help apps center view on tileset\n    this._calculateViewProps();\n\n    // TODO - Do we need this?\n    // Save the original, untransformed bounding volume position so we can apply\n    // the tile transform and model matrix at run time\n    // const boundingVolume = this._root.createBoundingVolume(\n    //   tilesetJson.root.boundingVolume,\n    //   Matrix4.IDENTITY\n    // );\n    // const clippingPlanesOrigin = boundingVolume.boundingSphere.center;\n    // If this origin is above the surface of the earth\n    // we want to apply an ENU orientation as our best guess of orientation.\n    // Otherwise, we assume it gets its position/orientation completely from the\n    // root tile transform and the tileset's model matrix\n    // const originCartographic = this._ellipsoid.cartesianToCartographic(clippingPlanesOrigin);\n    // if (\n    //   originCartographic &&\n    //   originCartographic.height > ApproximateTerrainHeights._defaultMinTerrainHeight\n    // ) {\n    //   this._initialClippingPlanesOriginMatrix = Transforms.eastNorthUpToFixedFrame(\n    //     clippingPlanesOrigin\n    //   );\n    // }\n\n    // this._clippingPlanesOriginMatrix = Matrix4.clone(this._initialClippingPlanesOriginMatrix);\n    // this._readyPromise.resolve(this);\n  }\n\n  // Called during initialize Tileset to initialize the tileset's cartographic center (longitude, latitude) and zoom.\n  _calculateViewProps() {\n    const root = this._root;\n    const {center} = root.boundingVolume;\n    // TODO - handle all cases\n    if (!center) {\n      // eslint-disable-next-line\n      console.warn('center was not pre-calculated for the root tile');\n      this.cartographicCenter = new Vector3();\n      this.zoom = 16;\n      return;\n    }\n    this.cartographicCenter = Ellipsoid.WGS84.cartesianToCartographic(center, new Vector3());\n    this.cartesianCenter = center;\n    this.zoom = getZoom(root.boundingVolume);\n  }\n\n  _initializeStats() {\n    this.stats.get(TILES_TOTAL);\n    this.stats.get(TILES_LOADING);\n    this.stats.get(TILES_IN_MEMORY);\n    this.stats.get(TILES_IN_VIEW);\n    this.stats.get(TILES_RENDERABLE);\n    this.stats.get(TILES_LOADED);\n    this.stats.get(TILES_UNLOADED);\n    this.stats.get(TILES_LOAD_FAILED);\n    this.stats.get(POINTS_COUNT, 'memory');\n    this.stats.get(TILES_GPU_MEMORY, 'memory');\n  }\n\n  // Installs the main tileset JSON file or a tileset JSON file referenced from a tile.\n  // eslint-disable-next-line max-statements\n  _initializeTileHeaders(tilesetJson, parentTileHeader, basePath) {\n    // A tileset JSON file referenced from a tile may exist in a different directory than the root tileset.\n    // Get the basePath relative to the external tileset.\n    const rootTile = new Tile3DHeader(this, tilesetJson.root, parentTileHeader, basePath); // resource\n\n    // If there is a parentTileHeader, add the root of the currently loading tileset\n    // to parentTileHeader's children, and update its _depth.\n    if (parentTileHeader) {\n      parentTileHeader.children.push(rootTile);\n      rootTile._depth = parentTileHeader._depth + 1;\n    }\n\n    const stack = [];\n    stack.push(rootTile);\n\n    while (stack.length > 0) {\n      const tile = stack.pop();\n      this.stats.get(TILES_TOTAL).incrementCount();\n      // this._allTilesAdditive = this._allTilesAdditive && tile.refine === TILE_3D_REFINE.ADD;\n\n      const children = tile._header.children || [];\n      for (const childHeader of children) {\n        const childTile = new Tile3DHeader(this, childHeader, tile, basePath);\n        tile.children.push(childTile);\n        childTile._depth = tile._depth + 1;\n        stack.push(childTile);\n      }\n\n      // TODO:\n      // if (this.options.cullWithChildrenBounds) {\n      //   Tile3DOptimizations.checkChildrenWithinParent(tile);\n      // }\n    }\n\n    return rootTile;\n  }\n\n  _destroyTileHeaders(parentTile) {\n    this._destroySubtree(parentTile);\n  }\n\n  async _loadTile(tile, frameState) {\n    // TODO - support tile expiration\n    // const expired = tile.contentExpired;\n    // if (expired) {\n    //   if (tile.hasTilesetContent) {\n    //     this._destroySubtree(tile);\n    //   }\n    // }\n\n    let loaded;\n\n    this.stats.get(TILES_LOADING).incrementCount();\n    try {\n      loaded = await tile.loadContent(frameState);\n    } catch (error) {\n      this.stats.get(TILES_LOADING).decrementCount();\n      this.stats.get(TILES_LOAD_FAILED).incrementCount();\n\n      const message = error.message || error.toString();\n      const url = tile.url;\n      // TODO - Allow for probe log to be injected instead of console?\n      console.error(`A 3D tile failed to load: ${tile.url} ${message}`); // eslint-disable-line\n      this.options.onTileError(tile, message, url);\n      return;\n    }\n    this.stats.get(TILES_LOADING).decrementCount();\n\n    if (!loaded) {\n      return;\n    }\n\n    // add coordinateOrigin and modelMatrix to tile\n    if (tile && tile._content) {\n      calculateTransformProps(tile, tile._content);\n    }\n\n    this.options.onTileLoad(tile);\n  }\n\n  _addTileToCache(tile) {\n    this.stats.get(TILES_LOADED).incrementCount();\n    this.stats.get(TILES_IN_MEMORY).incrementCount();\n\n    // Good enough? Just use the raw binary ArrayBuffer's byte length.\n    this.gpuMemoryUsageInBytes += tile._content.byteLength || 0;\n    this.stats.get(TILES_GPU_MEMORY).count = this.gpuMemoryUsageInBytes;\n  }\n\n  _unloadTile(tile) {\n    this.stats.get(TILES_IN_MEMORY).decrementCount();\n    this.stats.get(TILES_UNLOADED).incrementCount();\n\n    this.gpuMemoryUsageInBytes -= tile._content.byteLength || 0;\n    this.stats.get(TILES_GPU_MEMORY).count = this.gpuMemoryUsageInBytes;\n\n    this.options.onTileUnload(tile);\n    tile.unloadContent();\n  }\n\n  _unloadTiles() {\n    this._cache.unloadTiles(this, (tileset, tile) => tileset._unloadTile(tile));\n  }\n\n  // Traverse the tree and destroy all tiles\n  _destroy() {\n    const stack = [];\n    if (this._root) {\n      stack.push(this._root);\n    }\n    while (stack.length > 0) {\n      const tile = stack.pop();\n\n      for (const child of tile.children) {\n        stack.push(child);\n      }\n\n      // TODO - Use this._destroyTile(tile); ?\n      tile.destroy();\n    }\n    this._root = null;\n  }\n\n  // Traverse the tree and destroy all sub tiles\n  _destroySubtree(tile) {\n    const root = tile;\n    const stack = [];\n    stack.push(root);\n    while (stack.length > 0) {\n      tile = stack.pop();\n      for (const child of tile.children) {\n        stack.push(child);\n      }\n      if (tile !== root) {\n        this._destroyTile(tile);\n      }\n    }\n    root.children = [];\n  }\n\n  _destroyTile(tile) {\n    this._cache.unloadTile(this, tile);\n    this._unloadTile(tile);\n    tile.destroy();\n  }\n}\n"],"file":"tileset-3d.js"}