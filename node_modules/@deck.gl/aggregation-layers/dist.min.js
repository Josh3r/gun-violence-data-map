!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("deck"),require("luma")):"function"==typeof define&&define.amd?define(["deck","luma"],t):"object"==typeof exports?exports.deck=t(require("deck"),require("luma")):e.deck=t(e.deck,e.luma)}(window,(function(e,t){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}e.exports=function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){var i=n(13);function r(t,n,a){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=r=Reflect.get:e.exports=r=function(e,t,n){var r=i(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}},r(t,n,a||t)}e.exports=r},function(e,t,n){var i=n(10),r=n(12);e.exports=function(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?r(e):t}},function(e,t,n){var i=n(14);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}},function(e,t,n){var i=n(15),r=n(16),a=n(17);e.exports=function(e,t){return i(e)||r(e,t)||a()}},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(t){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?e.exports=i=function(e){return n(e)}:e.exports=i=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},i(t)}e.exports=i},function(e,t,n){var i=n(18),r=("undefined"==typeof window?global:window).deck||{};if(!r.LineLayer)throw new Error("@deck.gl/layers is not found");e.exports=Object.assign(r,i)},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,n){var i=n(3);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=i(e)););return e}},function(e,t){function n(t,i){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,i)}e.exports=n},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],i=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,a=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw a}}return n}}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t,n){"use strict";n.r(t);var i,r,a=n(0),o=n.n(a),s=n(5),u=n.n(s),l=n(4),g=n.n(l),c=n(7),d=n.n(c),f=n(3),h=n.n(f),p=n(6),v=n.n(p),m=n(8),y=n.n(m),x=n(1),S=n(2),b={SUM:1,MEAN:2,MIN:3,MAX:4};function w(e,t){return e+t}function A(e,t){return t>e?t:e}function C(e,t){return t<e?t:e}function M(e,t){switch(b[e.toUpperCase()]||b.SUM){case b.MIN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(C,1/0):null}(e,t)};case b.SUM:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(w,0):null}(e,t)};case b.MEAN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(w,0)/n.length:null}(e,t)};case b.MAX:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(A,-1/0):null}(e,t)};default:return null}}var D,P={projectPoints:!1,viewport:null,createBufferObjects:!0,moduleSettings:{}},O=[32775,32774],T=[32776,32774],_=[32776,32775],E=(i={},o()(i,b.SUM,32774),o()(i,b.MEAN,32774),o()(i,b.MIN,O),o()(i,b.MAX,T),i),k={size:1,operation:b.SUM,needMin:!1,needMax:!1,combineMaxMin:!1},z=(r={},o()(r,10240,9728),o()(r,10241,9728),"#define SHADER_NAME gpu-aggregation-to-grid-vs\n\nattribute vec3 positions;\nattribute vec3 positions64Low;\nattribute vec3 weights;\nuniform vec2 cellSize;\nuniform vec2 gridSize;\nuniform bool projectPoints;\nuniform vec2 translation;\nuniform vec3 scaling;\n\nvarying vec3 vWeights;\n\nvec2 project_to_pixel(vec4 pos) {\n  vec4 result;\n  pos.xy = pos.xy/pos.w;\n  result = pos + vec4(translation, 0., 0.);\n  result.xy = scaling.z > 0. ? result.xy * scaling.xy : result.xy;\n  return result.xy;\n}\n\nvoid main(void) {\n\n  vWeights = weights;\n\n  vec4 windowPos = vec4(positions, 1.);\n  if (projectPoints) {\n    windowPos = project_position_to_clipspace(positions, positions64Low, vec3(0));\n  }\n\n  vec2 pos = project_to_pixel(windowPos);\n\n  vec2 pixelXY64[2];\n  pixelXY64[0] = vec2(pos.x, 0.);\n  pixelXY64[1] = vec2(pos.y, 0.);\n  vec2 gridXY64[2];\n  gridXY64[0] = div_fp64(pixelXY64[0], vec2(cellSize.x, 0));\n  gridXY64[1] = div_fp64(pixelXY64[1], vec2(cellSize.y, 0));\n  float x = floor(gridXY64[0].x);\n  float y = floor(gridXY64[1].x);\n  pos = vec2(x, y);\n  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n}\n"),N="#define SHADER_NAME gpu-aggregation-to-grid-fs\n\nprecision highp float;\n\nvarying vec3 vWeights;\n\nvoid main(void) {\n  gl_FragColor = vec4(vWeights, 1.0);\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",j="#version 300 es\n#define SHADER_NAME gpu-aggregation-all-vs-64\n\nin vec2 position;\nuniform ivec2 gridSize;\nout vec2 vTextureCoord;\n\nvoid main(void) {\n  vec2 pos = vec2(-1.0, -1.0);\n  vec2 offset = 1.0 / vec2(gridSize);\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n\n  int yIndex = gl_InstanceID / gridSize[0];\n  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);\n\n  vec2 yIndexFP64 = vec2(float(yIndex), 0.);\n  vec2 xIndexFP64 = vec2(float(xIndex), 0.);\n  vec2 gridSizeYFP64 = vec2(gridSize[1], 0.);\n  vec2 gridSizeXFP64 = vec2(gridSize[0], 0.);\n\n  vec2 texCoordXFP64 = div_fp64(yIndexFP64, gridSizeYFP64);\n  vec2 texCoordYFP64 = div_fp64(xIndexFP64, gridSizeXFP64);\n\n  vTextureCoord = vec2(texCoordYFP64.x, texCoordXFP64.x);\n  gl_PointSize = 1.0;\n}\n",R="#version 300 es\n#define SHADER_NAME gpu-aggregation-all-fs\n\nprecision highp float;\n\nin vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform bool combineMaxMin;\nout vec4 fragColor;\nvoid main(void) {\n  vec4 textureColor = texture(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n  if (textureColor.a == 0.) {\n    discard;\n  }\n  fragColor.rgb = textureColor.rgb;\n  fragColor.a = combineMaxMin ? textureColor.r : textureColor.a;\n}\n",B="#define SHADER_NAME gpu-aggregation-transform-mean-vs\nattribute vec4 aggregationValues;\nvarying vec4 meanValues;\n\nvoid main()\n{\n  bool isCellValid = bool(aggregationValues.w > 0.);\n  meanValues.xyz = isCellValid ? aggregationValues.xyz/aggregationValues.w : vec3(0, 0, 0);\n  meanValues.w = aggregationValues.w;\n}\n",F=(D={},o()(D,10240,9728),o()(D,10241,9728),D);function I(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.width,i=void 0===n?1:n,r=t.height,a=void 0===r?1:r,o=t.data,s=void 0===o?null:o,u=t.unpackFlipY,l=void 0===u||u,g=t.parameters,c=void 0===g?F:g;return new S.Texture2D(e,{data:s,format:Object(S.isWebGL2)(e)?34836:6408,type:5126,border:0,mipmaps:!1,parameters:c,dataFormat:6408,width:i,height:a,unpackFlipY:l})}function W(e,t){var n=t.id,i=t.width,r=void 0===i?1:i,a=t.height,s=void 0===a?1:a,u=t.texture;return new S.Framebuffer(e,{id:n,width:r,height:s,attachments:o()({},36064,u)})}function U(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}var L=["aggregationBuffer","maxMinBuffer","minBuffer","maxBuffer"],G={maxData:"maxBuffer",minData:"minBuffer",maxMinData:"maxMinBuffer"},V=[S.FEATURES.WEBGL2,S.FEATURES.COLOR_ATTACHMENT_RGBA32F,S.FEATURES.BLEND_EQUATION_MINMAX,S.FEATURES.FLOAT_BLEND,S.FEATURES.TEXTURE_FLOAT],H=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};u()(this,e),this.id=n.id||"gpu-grid-aggregator",this.gl=t,this.state={weightAttributes:{},textures:{},meanTextures:{},buffers:{},framebuffers:{},maxMinFramebuffers:{},minFramebuffers:{},maxFramebuffers:{},equations:{},resources:{},results:{}},this._hasGPUSupport=Object(S.isWebGL2)(t)&&Object(S.hasFeatures)(this.gl,S.FEATURES.BLEND_EQUATION_MINMAX,S.FEATURES.COLOR_ATTACHMENT_RGBA32F,S.FEATURES.TEXTURE_FLOAT),this._hasGPUSupport&&this._setupModels()}return g()(e,null,[{key:"getAggregationData",value:function(e){var t=e.aggregationData,n=e.maxData,i=e.minData,r=e.maxMinData,a=4*e.pixelIndex,o={};return t&&(o.cellCount=t[a+3],o.cellWeight=t[a]),r?(o.maxCellWieght=r[0],o.minCellWeight=r[3]):(n&&(o.maxCellWieght=n[0],o.totalCount=n[3]),i&&(o.minCellWeight=i[0],o.totalCount=n[3])),o}},{key:"getCellData",value:function(e){for(var t=e.countsData,n=e.size,i=void 0===n?1:n,r=t.length/4,a=new Float32Array(r*i),o=new Uint32Array(r),s=0;s<r;s++){for(var u=0;u<i;u++)a[s*i+u]=t[4*s+u];o[s]=t[4*s+3]}return{cellCounts:o,cellWeights:a}}},{key:"isSupported",value:function(e){return Object(S.hasFeatures)(e,V)}}]),g()(e,[{key:"delete",value:function(){var e=this.gridAggregationModel,t=this.allAggregationModel,n=this.meanTransform,i=this.state,r=i.textures,a=i.framebuffers,o=i.maxMinFramebuffers,s=i.minFramebuffers,u=i.maxFramebuffers,l=i.meanTextures,g=i.resources;e&&e.delete(),t&&t.delete(),n&&n.delete(),function(e){(e=Array.isArray(e)?e:[e]).forEach((function(e){for(var t in e)e[t].delete()}))}([a,r,o,s,u,l,g])}},{key:"run",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.setState({results:{}});var t=this._normalizeAggregationParams(e);return this._hasGPUSupport||x.log.log(1,"GPUGridAggregator: not supported")(),this._runAggregation(t)}},{key:"getData",value:function(e){var t={},n=this.state.results;for(var i in n[e].aggregationData||(n[e].aggregationData=n[e].aggregationBuffer.getData()),t.aggregationData=n[e].aggregationData,G){var r=G[i];(n[e][i]||n[e][r])&&(n[e][i]=n[e][i]||n[e][r].getData(),t[i]=n[e][i])}return t}},{key:"updateShaders",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.setState({shaderOptions:e,modelDirty:!0})}},{key:"_normalizeAggregationParams",value:function(e){var t=Object.assign({},P,e),n=t.weights;return n&&(t.weights=function(e){var t={};for(var n in e)t[n]=Object.assign({},k,e[n]);return t}(n)),t}},{key:"setState",value:function(e){Object.assign(this.state,e)}},{key:"_getAggregateData",value:function(e){var t={},n=this.state,i=n.textures,r=n.framebuffers,a=n.maxMinFramebuffers,o=n.minFramebuffers,s=n.maxFramebuffers,u=n.resources,l=e.weights;for(var g in l){t[g]={};var c=l[g],d=c.needMin,f=c.needMax,h=c.combineMaxMin;t[g].aggregationTexture=i[g],t[g].aggregationBuffer=Object(S.readPixelsToBuffer)(r[g],{target:l[g].aggregationBuffer,sourceType:5126}),d&&f&&h?(t[g].maxMinBuffer=Object(S.readPixelsToBuffer)(a[g],{target:l[g].maxMinBuffer,sourceType:5126}),t[g].maxMinTexture=u["".concat(g,"-maxMinTexture")]):(d&&(t[g].minBuffer=Object(S.readPixelsToBuffer)(o[g],{target:l[g].minBuffer,sourceType:5126}),t[g].minTexture=u["".concat(g,"-minTexture")]),f&&(t[g].maxBuffer=Object(S.readPixelsToBuffer)(s[g],{target:l[g].maxBuffer,sourceType:5126}),t[g].maxTexture=u["".concat(g,"-maxTexture")]))}return this._trackGPUResultBuffers(t,l),t}},{key:"_renderAggregateData",value:function(e){var t=e.cellSize,n=e.projectPoints,i=e.attributes,r=e.moduleSettings,a=e.numCol,o=e.numRow,s=e.weights,u=e.translation,l=e.scaling,g=this.state,c=g.maxMinFramebuffers,d=g.minFramebuffers,f=g.maxFramebuffers,h=[a,o],p={blend:!0,depthTest:!1,blendFunc:[1,1]},v={cellSize:t,gridSize:h,projectPoints:n,translation:u,scaling:l};for(var m in s){var y=s[m],x=y.needMin,S=y.needMax,b=x&&S&&s[m].combineMaxMin;this._renderToWeightsTexture({id:m,parameters:p,moduleSettings:r,uniforms:v,gridSize:h,attributes:i,weights:s}),b?this._renderToMaxMinTexture({id:m,parameters:Object.assign({},p,{blendEquation:_}),gridSize:h,minOrMaxFb:c[m],clearParams:{clearColor:[0,0,0,3402823466e29]},combineMaxMin:b}):(x&&this._renderToMaxMinTexture({id:m,parameters:Object.assign({},p,{blendEquation:O}),gridSize:h,minOrMaxFb:d[m],clearParams:{clearColor:[3402823466e29,3402823466e29,3402823466e29,0]},combineMaxMin:b}),S&&this._renderToMaxMinTexture({id:m,parameters:Object.assign({},p,{blendEquation:T}),gridSize:h,minOrMaxFb:f[m],clearParams:{clearColor:[0,0,0,0]},combineMaxMin:b}))}}},{key:"_renderToMaxMinTexture",value:function(e){var t=e.id,n=e.parameters,i=e.gridSize,r=e.minOrMaxFb,a=e.combineMaxMin,o=e.clearParams,s=void 0===o?{}:o,u=this.state.framebuffers,l=this.gl,g=this.allAggregationModel;r.bind(),l.viewport(0,0,i[0],i[1]),Object(S.withParameters)(l,s,(function(){l.clear(16384)})),g.draw({parameters:n,uniforms:{uSampler:u[t].texture,gridSize:i,combineMaxMin:a}}),r.unbind()}},{key:"_renderToWeightsTexture",value:function(e){var t=e.id,n=e.parameters,i=e.moduleSettings,r=e.uniforms,a=e.gridSize,s=e.weights,u=this.state,l=u.framebuffers,g=u.equations,c=u.weightAttributes,d=this.gl,f=this.gridAggregationModel,h=s[t].operation;l[t].bind(),d.viewport(0,0,a[0],a[1]);var p=h===b.MIN?[3402823466e29,3402823466e29,3402823466e29,0]:[0,0,0,0];Object(S.withParameters)(d,{clearColor:p},(function(){d.clear(16384)}));var v={weights:c[t]};if(f.draw({parameters:Object.assign({},n,{blendEquation:g[t]}),moduleSettings:i,uniforms:r,attributes:v}),l[t].unbind(),h===b.MEAN){var m=this.state,y=m.meanTextures,x=m.textures,w={_sourceTextures:{aggregationValues:y[t]},_targetTexture:x[t],elementCount:x[t].width*x[t].height};this.meanTransform?this.meanTransform.update(w):this.meanTransform=function(e,t){return new S.Transform(e,Object.assign({},{vs:B,_targetTextureVarying:"meanValues"},t))}(d,w),this.meanTransform.run({parameters:{blend:!1,depthTest:!1}}),l[t].attach(o()({},36064,x[t]))}}},{key:"_runAggregation",value:function(e){this._updateModels(e),this._setupFramebuffers(e),this._renderAggregateData(e);var t=this._getAggregateData(e);return this.setState({results:t}),t}},{key:"_setupFramebuffers",value:function(e){var t=this.state,n=t.textures,i=t.framebuffers,r=t.maxMinFramebuffers,a=t.minFramebuffers,s=t.maxFramebuffers,u=t.meanTextures,l=t.equations,g=e.weights,c=e.numCol,d=e.numRow,f={width:c,height:d};for(var h in g){var p=g[h],v=p.needMin,m=p.needMax,y=p.combineMaxMin,x=p.operation;n[h]=g[h].aggregationTexture||n[h]||I(this.gl,{id:"".concat(h,"-texture"),width:c,height:d}),n[h].resize(f);var S=n[h];x===b.MEAN&&(u[h]=u[h]||I(this.gl,{id:"".concat(h,"-mean-texture"),width:c,height:d}),u[h].resize(f),S=u[h]),i[h]?i[h].attach(o()({},36064,S)):i[h]=W(this.gl,{id:"".concat(h,"-fb"),width:c,height:d,texture:S}),i[h].resize(f),l[h]=E[x]||E.SUM,(v||m)&&(v&&m&&y?r[h]||(S=g[h].maxMinTexture||this._getMinMaxTexture("".concat(h,"-maxMinTexture")),r[h]=W(this.gl,{id:"".concat(h,"-maxMinFb"),texture:S})):(v&&(a[h]||(S=g[h].minTexture||this._getMinMaxTexture("".concat(h,"-minTexture")),a[h]=W(this.gl,{id:"".concat(h,"-minFb"),texture:S}))),m&&(s[h]||(S=g[h].maxTexture||this._getMinMaxTexture("".concat(h,"-maxTexture")),s[h]=W(this.gl,{id:"".concat(h,"-maxFb"),texture:S})))))}}},{key:"_getMinMaxTexture",value:function(e){var t=this.state.resources;return t[e]||(t[e]=I(this.gl,{id:"resourceName"})),t[e]}},{key:"_setupModels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.numCol,n=void 0===t?0:t,i=e.numRow,r=void 0===i?0:i,a=this.gl,o=this.state.shaderOptions;if(this.gridAggregationModel&&this.gridAggregationModel.delete(),this.gridAggregationModel=X(a,o),!this.allAggregationModel){var s=n*r;this.allAggregationModel=Y(a,s)}}},{key:"_setupWeightAttributes",value:function(e){var t=this.state.weightAttributes,n=e.weights;for(var i in n)t[i]=e.attributes[i]}},{key:"_trackGPUResultBuffers",value:function(e,t){var n=this.state.resources;for(var i in e)if(e[i]){var r=!0,a=!1,o=void 0;try{for(var s,u=L[Symbol.iterator]();!(r=(s=u.next()).done);r=!0){var l=s.value;if(e[i][l]&&t[i][l]!==e[i][l]){var g="gpu-result-".concat(i,"-").concat(l);n[g]&&n[g].delete(),n[g]=e[i][l]}}}catch(e){a=!0,o=e}finally{try{r||null==u.return||u.return()}finally{if(a)throw o}}}}},{key:"_updateModels",value:function(e){var t=e.vertexCount,n=e.attributes,i=e.numCol,r=e.numRow;this.state.modelDirty&&(this._setupModels(e),this.setState({modelDirty:!1})),this._setupWeightAttributes(e),this.gridAggregationModel.setVertexCount(t),this.gridAggregationModel.setAttributes(n),this.allAggregationModel.setInstanceCount(i*r)}}]),e}();function X(e,t){var n=Object(x._mergeShaders)({vs:z,fs:N,modules:[S.fp64arithmetic,x.project32]},t);return new S.Model(e,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?U(n,!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):U(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({id:"Gird-Aggregation-Model",vertexCount:1,drawMode:0},n))}function Y(e,t){return new S.Model(e,{id:"All-Aggregation-Model",vs:j,fs:R,modules:[S.fp64arithmetic],vertexCount:1,drawMode:0,isInstanced:!0,instanceCount:t,attributes:{position:[0,0]}})}var q=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function K(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Float32Array;if(Number.isFinite(e[0]))t=new i(e);else{t=new i(4*e.length);for(var r=0,a=0;a<e.length;a++){var o=e[a];t[r++]=o[0],t[r++]=o[1],t[r++]=o[2],t[r++]=Number.isFinite(o[3])?o[3]:255}}if(n)for(var s=0;s<t.length;s++)t[s]/=255;return t}var Q=[0,0,0,0],Z=[0,255,0,255],J=["minColor","maxColor","colorRange","colorDomain"],$={cellSizePixels:{value:100,min:1},cellMarginPixels:{value:2,min:0,max:5},colorDomain:null,colorRange:q},ee=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"getShaders",value:function(){return{vs:"#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\n\nattribute vec3 positions;\nattribute vec3 instancePositions;\nattribute vec4 instanceCounts;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\nuniform sampler2D maxTexture;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r;\n  float maxWeight = texture2D(maxTexture, vec2(0.5)).r;\n\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#define SHADER_NAME screen-grid-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[x.picking]}}},{key:"initializeState",value:function(){var e=this.context.gl;this.getAttributeManager().addInstanced({instancePositions:{size:3,update:this.calculateInstancePositions},instanceCounts:{size:4,noAlloc:!0}}),this.setState({model:this._getModel(e)})}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){var n=e.oldProps,i=e.props,r=e.changeFlags;v()(h()(t.prototype),"updateState",this).call(this,{oldProps:n,props:i,changeFlags:r});var a=this.getAttributeManager();i.numInstances!==n.numInstances?a.invalidateAll():n.cellSizePixels!==i.cellSizePixels&&a.invalidate("instancePositions"),this._updateUniforms(n,i,r)}},{key:"draw",value:function(e){var t=e.uniforms,n=this.props,i=n.parameters,r=n.maxTexture,a=this.props.minColor||Q,o=this.props.maxColor||Z,s=this.props.colorDomain||[1,0],u=this.state.model,l={minColor:a,maxColor:o,maxTexture:r,colorDomain:s};t=Object.assign(l,t),u.draw({uniforms:t,parameters:Object.assign({depthTest:!1,depthMask:!1},i)})}},{key:"calculateInstancePositions",value:function(e,t){for(var n=t.numInstances,i=this.context.viewport,r=i.width,a=i.height,o=this.props.cellSizePixels,s=Math.ceil(r/o),u=e.value,l=e.size,g=0;g<n;g++){var c=g%s,d=Math.floor(g/s);u[g*l+0]=c*o/r*2-1,u[g*l+1]=1-d*o/a*2,u[g*l+2]=0}}},{key:"_getModel",value:function(e){return new S.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new S.Geometry({drawMode:6,attributes:{positions:new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0])}}),isInstanced:!0}))}},{key:"_shouldUseMinMax",value:function(){var e=this.props,t=e.minColor,n=e.maxColor,i=e.colorDomain,r=e.colorRange;return t||n?(x.log.deprecated("ScreenGridLayer props: minColor and maxColor","colorRange, colorDomain")(),!0):!i&&!r}},{key:"_updateUniforms",value:function(e,t,n){var i=this.state.model;if(J.some((function(n){return e[n]!==t[n]}))&&i.setUniforms({shouldUseMinMax:this._shouldUseMinMax()}),e.colorRange!==t.colorRange&&i.setUniforms({colorRange:K(t.colorRange)}),e.cellMarginPixels!==t.cellMarginPixels||e.cellSizePixels!==t.cellSizePixels||n.viewportChanged){var r=this.context.viewport,a=r.width,o=r.height,s=this.props,u=s.cellSizePixels,l=s.cellMarginPixels,g=u>l?l:0,c=new Float32Array([(u-g)/a*2,-(u-g)/o*2,1]);i.setUniforms({cellScale:c})}}}],[{key:"isSupported",value:function(e){return Object(S.hasFeatures)(e,[S.FEATURES.TEXTURE_FLOAT])}}]),t}(x.Layer);function te(e,t){var n={};for(var i in e)t.includes(i)||(n[i]=e[i]);return n}ee.layerName="ScreenGridCellLayer",ee.defaultProps=$;var ne=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(e){v()(h()(t.prototype),"initializeState",this).call(this),this.setState({ignoreProps:te(this.constructor._propTypes,e.data.props),dimensions:e})}},{key:"updateState",value:function(e){if(v()(h()(t.prototype),"updateState",this).call(this,e),e.changeFlags.extensionsChanged){var n=this.getShaders({});n&&n.defines&&(n.defines.NON_INSTANCED_MODEL=1),this.updateShaders(n)}this._updateAttributes(e.props)}},{key:"updateAttributes",value:function(e){this.setState({changedAttributes:e})}},{key:"getAttributes",value:function(){return this.getAttributeManager().getShaderAttributes()}},{key:"getModuleSettings",value:function(){var e=this.context,t=e.viewport,n=e.mousePosition,i=e.gl;return Object.assign(Object.create(this.props),{viewport:t,mousePosition:n,pickingActive:0,devicePixelRatio:Object(S.cssToDeviceRatio)(i)})}},{key:"updateShaders",value:function(e){}},{key:"isAggregationDirty",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.props,i=e.oldProps,r=e.changeFlags,a=t.compareAll,o=void 0!==a&&a,s=t.dimension,u=this.state.ignoreProps,l=s.props,g=s.accessors,c=void 0===g?[]:g,d=r.updateTriggersChanged;if(d){if(d.all)return!0;var f=!0,h=!1,p=void 0;try{for(var v,m=c[Symbol.iterator]();!(f=(v=m.next()).done);f=!0){var y=v.value;if(d[y])return!0}}catch(e){h=!0,p=e}finally{try{f||null==m.return||m.return()}finally{if(h)throw p}}}if(o)return!!r.extensionsChanged||Object(x._compareProps)({oldProps:i,newProps:n,ignoreProps:u,propTypes:this.constructor._propTypes});var S=!0,b=!1,w=void 0;try{for(var A,C=l[Symbol.iterator]();!(S=(A=C.next()).done);S=!0){var M=A.value;if(n[M]!==i[M])return!0}}catch(e){b=!0,w=e}finally{try{S||null==C.return||C.return()}finally{if(b)throw w}}return!1}},{key:"isAttributeChanged",value:function(e){var t=this.state.changedAttributes;return e?t&&void 0!==t[e]:!function(e){var t=!0;for(var n in e){t=!1;break}return t}(t)}},{key:"_getAttributeManager",value:function(){return new x.AttributeManager(this.context.gl,{id:this.props.id,stats:this.context.stats})}}]),t}(x.CompositeLayer);ne.layerName="AggregationLayer";var ie=n(9),re=n.n(ie);function ae(e,t,n){var i=n;return i.domain=function(){return e},i.range=function(){return t},i}function oe(e,t){return ae(e,t,(function(n){return function(e,t,n){var i=e[1]-e[0];if(i<=0)return x.log.warn("quantizeScale: invalid domain, returning range[0]")(),t[0];var r=i/t.length,a=Math.floor((n-e[0])/r),o=Math.max(Math.min(a,t.length-1),0);return t[o]}(e,t,n)}))}function se(e,t){return ae(e,t,(function(n){return function(e,t,n){return(n-e[0])/(e[1]-e[0])*(t[1]-t[0])+t[0]}(e,t,n)}))}function ue(e,t){for(var n=e.sort(le),i=0,r=Math.max(1,t.length),a=new Array(r-1);++i<r;)a[i-1]=ge(n,i/r);var o=function(e){return function(e,t,n){return t[function(e,t){var n=0,i=e.length;for(;n<i;){var r=n+i>>>1;le(e[r],t)>0?i=r:n=r+1}return n}(e,n)]}(a,t,e)};return o.thresholds=function(){return a},ae(e,t,o)}function le(e,t){return e-t}function ge(e,t){var n=e.length;if(t<=0||n<2)return e[0];if(t>=1)return e[n-1];var i=(n-1)*t,r=Math.floor(i),a=e[r];return a+(e[r+1]-a)*(i-r)}function ce(e,t){var n=new Map,i=[],r=!0,a=!1,o=void 0;try{for(var s,u=e[Symbol.iterator]();!(r=(s=u.next()).done);r=!0){var l=s.value,g="".concat(l);n.has(g)||n.set(g,i.push(l))}}catch(e){a=!0,o=e}finally{try{r||null==u.return||u.return()}finally{if(a)throw o}}return ae(e,t,(function(e){return function(e,t,n,i){var r="".concat(i),a=t.get(r);return void 0===a&&(a=e.push(i),t.set(r,a)),n[(a-1)%n.length]}(i,n,t,e)}))}function de(e){return null!=e}function fe(e,t){return("function"==typeof t?e.map(t):e).filter(de)}function he(e,t){return fe(e,t)}function pe(e,t){return n=fe(e,t),i=[],n.forEach((function(e){!i.includes(e)&&de(e)&&i.push(e)})),i;var n,i}var ve=function(e){return e.length},me=function(e){return e.points},ye=function(e){return e.index},xe={getValue:ve,getPoints:me,getIndex:ye,filterData:null},Se=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:xe;u()(this,e),this.aggregatedBins=this.getAggregatedBins(t,n),this._updateMinMaxValues(),this.binMap=this.getBinMap()}return g()(e,[{key:"getAggregatedBins",value:function(e,t){for(var n=t.getValue,i=void 0===n?ve:n,r=t.getPoints,a=void 0===r?me:r,o=t.getIndex,s=void 0===o?ye:o,u=t.filterData,l="function"==typeof u,g=e.length,c=[],d=0,f=0;f<g;f++){var h=e[f],p=a(h),v=s(h),m=l?p.filter(u):p;h.filteredPoints=l?m:null;var y=m.length?i(m):null;null!=y&&(c[d]={i:Number.isFinite(v)?v:f,value:y,counts:m.length},d++)}return c}},{key:"_percentileToIndex",value:function(e){var t=this.sortedBins.length;if(t<2)return[0,0];var n=e.map((function(e){return t=e,n=0,i=100,Math.max(n,Math.min(i,t));var t,n,i})),i=re()(n,2),r=i[0],a=i[1];return[Math.ceil(r/100*(t-1)),Math.floor(a/100*(t-1))]}},{key:"getBinMap",value:function(){var e={},t=!0,n=!1,i=void 0;try{for(var r,a=this.aggregatedBins[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value;e[o.i]=o}}catch(e){n=!0,i=e}finally{try{t||null==a.return||a.return()}finally{if(n)throw i}}return e}},{key:"_updateMinMaxValues",value:function(){var e=0,t=0,n=3402823466e29,i=0,r=!0,a=!1,o=void 0;try{for(var s,u=this.aggregatedBins[Symbol.iterator]();!(r=(s=u.next()).done);r=!0){var l=s.value;e=e>l.counts?e:l.counts,t=t>l.value?t:l.value,n=n<l.value?n:l.value,i+=l.counts}}catch(e){a=!0,o=e}finally{try{r||null==u.return||u.return()}finally{if(a)throw o}}this.maxCount=e,this.maxValue=t,this.minValue=n,this.totalCount=i}},{key:"getValueRange",value:function(e){if(this.sortedBins||(this.sortedBins=this.aggregatedBins.sort((function(e,t){return e.value-t.value}))),!this.sortedBins.length)return[];var t=0,n=this.sortedBins.length-1;if(Array.isArray(e)){var i=this._percentileToIndex(e);t=i[0],n=i[1]}return[this.sortedBins[t].value,this.sortedBins[n].value]}},{key:"getValueDomainByScale",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=re()(t,2),i=n[0],r=void 0===i?0:i,a=n[1],o=void 0===a?100:a;if(this.sortedBins||(this.sortedBins=this.aggregatedBins.sort((function(e,t){return e.value-t.value}))),!this.sortedBins.length)return[];var s=this._percentileToIndex([r,o]);return this._getScaleDomain(e,s)}},{key:"_getScaleDomain",value:function(e,t){var n=re()(t,2),i=n[0],r=n[1],a=this.sortedBins;switch(e){case"quantize":case"linear":return[a[i].value,a[r].value];case"quantile":return he(a.slice(i,r+1),(function(e){return e.value}));case"ordinal":return pe(a,(function(e){return e.value}));default:return[a[i].value,a[r].value]}}}]),e}(),be=6378e3;function we(e){return Number.isFinite(e)?e:0}function Ae(e,t){for(var n,i,r=e.positions.value,a=1/0,o=-1/0,s=1/0,u=-1/0,l=0;l<t;l++)i=r[3*l],a=(n=r[3*l+1])<a?n:a,o=n>o?n:o,s=i<s?i:s,u=i>u?i:u;return{xMin:we(s),xMax:we(u),yMin:we(a),yMax:we(o)}}function Ce(e,t){var n=e<0?-1:1,i=n<0?Math.abs(e)+t:Math.abs(e);return(i=Math.floor(i/t)*t)*n}function Me(e,t){return arguments.length>2&&void 0!==arguments[2]&&!arguments[2]?{xOffset:t,yOffset:t}:function(e,t){var n=(o=e,o/be*(180/Math.PI)),i=(r=t,a=e,a/be*(180/Math.PI)/Math.cos(r*Math.PI/180));var r,a;var o;return{yOffset:n,xOffset:i}}(t,(e.yMin+e.yMax)/2)}function De(e,t,n,i){var r=Me(e,t,i!==x.COORDINATE_SYSTEM.CARTESIAN),a=function(e,t,n,i){var r=i.width,a=i.height,o=n===x.COORDINATE_SYSTEM.CARTESIAN?[-r/2,-a/2]:[-180,-90];x.log.assert([x.COORDINATE_SYSTEM.CARTESIAN,x.COORDINATE_SYSTEM.LNGLAT,x.COORDINATE_SYSTEM.DEFAULT].includes(n));var s=e.xMin,u=e.yMin;return[-1*(Ce(s-o[0],t.xOffset)+o[0]),-1*(Ce(u-o[1],t.yOffset)+o[1])]}(e,r,i,n),o=e.xMin,s=e.yMin,u=e.xMax,l=e.yMax,g=u-o+r.xOffset,c=l-s+r.yOffset;return{gridOffset:r,translation:a,width:g,height:c,numCol:Math.ceil(g/r.xOffset),numRow:Math.ceil(c/r.yOffset)}}function Pe(e,t){var n=function(e,t){var n=e.data,i=void 0===n?[]:n,r=e.cellSize,a=t.attributes,o=t.viewport,s=t.projectPoints,u=t.numInstances,l=a.positions.value,g=a.positions.getAccessor().size,c=t.boundingBox||function(e,t){for(var n,i,r=e.value,a=e.getAccessor().size,o=1/0,s=-1/0,u=1/0,l=-1/0,g=0;g<t;g++)i=r[g*a],n=r[g*a+1],Number.isFinite(i)&&Number.isFinite(n)&&(o=n<o?n:o,s=n>s?n:s,u=i<u?i:u,l=i>l?i:l);return{xMin:u,xMax:l,yMin:o,yMax:s}}(a.positions,u),d=t.posOffset||[180,90],f=t.gridOffset||Me(c,r);if(f.xOffset<=0||f.yOffset<=0)return{gridHash:{},gridOffset:f};var h=o.width,p=o.height,v=Math.ceil(h/f.xOffset),m=Math.ceil(p/f.yOffset),y={},S=Object(x.createIterable)(i),b=S.iterable,w=S.objectInfo,A=new Array(3),C=!0,M=!1,D=void 0;try{for(var P,O=b[Symbol.iterator]();!(C=(P=O.next()).done);C=!0){var T=P.value;w.index++,A[0]=l[w.index*g],A[1]=l[w.index*g+1],A[2]=g>=3?l[w.index*g+2]:0;var _=s?o.project(A):A,E=re()(_,2),k=E[0],z=E[1];if(Number.isFinite(k)&&Number.isFinite(z)){var N=Math.floor((z+d[1])/f.yOffset),j=Math.floor((k+d[0])/f.xOffset);if(!s||j>=0&&j<v&&N>=0&&N<m){var R="".concat(N,"-").concat(j);y[R]=y[R]||{count:0,points:[],lonIdx:j,latIdx:N},y[R].count+=1,y[R].points.push(T)}}}}catch(e){M=!0,D=e}finally{try{C||null==O.return||O.return()}finally{if(M)throw D}}return{gridHash:y,gridOffset:f,offsets:[-1*d[0],-1*d[1]]}}(e,t),i=function(e){var t=e.gridHash,n=e.gridOffset,i=e.offsets,r=new Array(Object.keys(t).length),a=0;for(var o in t){var s=o.split("-"),u=parseInt(s[0],10),l=parseInt(s[1],10),g=a++;r[g]=Object.assign({index:g,position:[i[0]+n.xOffset*l,i[1]+n.yOffset*u]},t[o])}return r}(n);return{gridHash:n.gridHash,gridOffset:n.gridOffset,data:i}}var Oe=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(e){var n=e.dimensions,i=this.context.gl;v()(h()(t.prototype),"initializeState",this).call(this,n),this.setState({layerData:{},gpuGridAggregator:new H(i,{id:"".concat(this.id,"-gpu-aggregator")}),cpuGridAggregator:Pe})}},{key:"updateState",value:function(e){v()(h()(t.prototype),"updateState",this).call(this,e),this.updateAggregationState(e);var n=this.state,i=n.aggregationDataDirty,r=n.aggregationWeightsDirty,a=n.gpuAggregation;if(!(this.getNumInstances()<=0)){var o=!1;(i||a&&r)&&(this._updateAggregation(e),o=!0),a||!i&&!r||(this._updateWeightBins(),this._uploadAggregationResults(),o=!0),this.setState({aggregationDirty:o})}}},{key:"finalizeState",value:function(){var e=this.state.weights.count;e&&e.aggregationBuffer&&e.aggregationBuffer.delete();var n=this.state.gpuGridAggregator;n&&n.delete(),v()(h()(t.prototype),"finalizeState",this).call(this)}},{key:"updateShaders",value:function(e){this.state.gpuAggregation&&this.state.gpuGridAggregator.updateShaders(e)}},{key:"updateAggregationState",value:function(e){x.log.assert(!1)}},{key:"allocateResources",value:function(e,t){if(this.state.numRow!==e||this.state.numCol!==t){var n=t*e*4*4,i=this.context.gl,r=this.state.weights;for(var a in r){var o=r[a];o.aggregationBuffer&&o.aggregationBuffer.delete(),o.aggregationBuffer=new S.Buffer(i,{byteLength:n,accessor:{size:4,type:5126,divisor:1}})}}}},{key:"updateResults",value:function(e){var t=e.aggregationData,n=e.maxMinData,i=e.maxData,r=e.minData,a=this.state.weights.count;a&&(a.aggregationData=t,a.maxMinData=n,a.maxData=i,a.minData=r)}},{key:"_updateAggregation",value:function(e){var t=this.state,n=t.cpuGridAggregator,i=t.gpuGridAggregator,r=t.gridOffset,a=t.posOffset,o=t.translation,s=void 0===o?[0,0]:o,u=t.scaling,l=void 0===u?[0,0,0]:u,g=t.boundingBox,c=t.projectPoints,d=t.gpuAggregation,f=t.numCol,h=t.numRow,p=e.props,v=this.context.viewport,m=this.getAttributes(),y=this.getNumInstances();if(d){var x=this.state.weights;i.run({weights:x,cellSize:[r.xOffset,r.yOffset],numCol:f,numRow:h,translation:s,scaling:l,vertexCount:y,projectPoints:c,attributes:m,moduleSettings:this.getModuleSettings()})}else{var S=n(p,{gridOffset:r,projectPoints:c,attributes:m,viewport:v,posOffset:a,boundingBox:g});this.setState({layerData:S})}}},{key:"_updateWeightBins",value:function(){var e=this.state.getValue,t=new Se(this.state.layerData.data||[],{getValue:e});this.setState({sortedBins:t})}},{key:"_uploadAggregationResults",value:function(){var e=this.state,t=e.numCol,n=e.numRow,i=this.state.layerData.data,r=this.state.sortedBins,a=r.aggregatedBins,o=r.minValue,s=r.maxValue,u=r.totalCount,l=new Float32Array(t*n*4).fill(0),g=!0,c=!1,d=void 0;try{for(var f,h=a[Symbol.iterator]();!(g=(f=h.next()).done);g=!0){var p=f.value,v=i[p.i],m=v.lonIdx,y=v.latIdx,x=p.value,S=p.counts,b=4*(m+y*t);l[b]=x,l[b+4-1]=S}}catch(e){c=!0,d=e}finally{try{g||null==h.return||h.return()}finally{if(c)throw d}}var w=new Float32Array([s,0,0,o]),A=new Float32Array([s,0,0,u]),C=new Float32Array([o,0,0,u]);this.updateResults({aggregationData:l,maxMinData:w,maxData:A,minData:C})}}]),t}(ne);Oe.layerName="GridAggregationLayer";var Te=Object.assign({},ee.defaultProps,{getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return 1}},gpuAggregation:!0,aggregation:"SUM"}),_e={data:{props:["cellSizePixels"]},weights:{props:["aggregation"],accessors:["getWeight"]}},Ee=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(){var e,n=this.context.gl;if(!ee.isSupported(n))return this.setState({supported:!1}),void x.log.error("ScreenGridLayer: ".concat(this.id," is not supported on this browser"))();v()(h()(t.prototype),"initializeState",this).call(this,{dimensions:_e,getCellSize:function(e){return e.cellSizePixels}});var i={count:{size:1,operation:b.SUM,needMax:!0,maxTexture:I(n,{id:"".concat(this.id,"-max-texture")})}};this.setState({supported:!0,projectPoints:!0,weights:i,subLayerData:{attributes:{}},maxTexture:i.count.maxTexture,positionAttributeName:"positions",posOffset:[0,0],translation:[1,-1]}),this.getAttributeManager().add((e={},o()(e,"positions",{size:3,accessor:"getPosition",type:5130,fp64:this.use64bitPositions()}),o()(e,"count",{size:3,accessor:"getWeight"}),e))}},{key:"shouldUpdateState",value:function(e){var t=e.changeFlags;return this.state.supported&&t.somethingChanged}},{key:"updateState",value:function(e){v()(h()(t.prototype),"updateState",this).call(this,e)}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var e=this.state,t=e.maxTexture,n=e.numRow,i=e.numCol,r=e.weights,a=this.props.updateTriggers,o=r.count.aggregationBuffer;return new(this.getSubLayerClass("cells",ee))(this.props,this.getSubLayerProps({id:"cell-layer",updateTriggers:a}),{data:{attributes:{instanceCounts:o}},maxTexture:t,numInstances:n*i})}},{key:"finalizeState",value:function(){v()(h()(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.aggregationBuffer,i=e.maxBuffer,r=e.gpuGridAggregator,a=e.maxTexture;r.delete(),n&&n.delete(),i&&i.delete(),a&&a.delete()}},{key:"getPickingInfo",value:function(e){var t=e.info,n=(e.mode,t.index);if(n>=0){var i=this.state.gpuGridAggregator.getData("count");t.object=H.getAggregationData(Object.assign({pixelIndex:n},i))}return t}},{key:"updateResults",value:function(e){var t=e.aggregationData,n=e.maxData,i=this.state.weights.count;i.aggregationData=t,i.aggregationBuffer.setData({data:t}),i.maxData=n,i.maxTexture.setImageData({data:n})}},{key:"updateAggregationState",value:function(e){var t=e.props.cellSizePixels,n=e.oldProps.cellSizePixels!==t,i=e.changeFlags.viewportChanged,r=e.props.gpuAggregation;this.state.gpuAggregation!==e.props.gpuAggregation&&r&&!H.isSupported(this.context.gl)&&(x.log.warn("GPU Grid Aggregation not supported, falling back to CPU")(),r=!1);var a=r!==this.state.gpuAggregation;this.setState({gpuAggregation:r});var o=this.isAttributeChanged("positions"),s=this.state.dimensions,u=s.data,l=s.weights,g=o||a||i||this.isAggregationDirty(e,{compareAll:r,dimension:u}),c=this.isAggregationDirty(e,{dimension:l});this.setState({aggregationDataDirty:g,aggregationWeightsDirty:c});var d=this.context.viewport;if(i||n){var f=d.width,h=d.height,p=Math.ceil(f/t),v=Math.ceil(h/t);this.allocateResources(v,p),this.setState({scaling:[f/2,-h/2,1],gridOffset:{xOffset:t,yOffset:t},width:f,height:h,numCol:p,numRow:v})}c&&this._updateAccessors(e),(g||c)&&this._resetResults()}},{key:"_updateAccessors",value:function(e){var t=e.props,n=t.getWeight,i=t.aggregation,r=this.state.weights.count;r&&(r.getWeight=n,r.operation=b[i]),this.setState({getValue:M(i,n)})}},{key:"_resetResults",value:function(){var e=this.state.weights.count;e&&(e.aggregationData=null)}}]),t}(Oe);Ee.layerName="ScreenGridLayer",Ee.defaultProps=Te;var ke=n(10),ze=n.n(ke);function Ne(){}var je=["getBins","getDomain","getScaleFunc"],Re=[{key:"fillColor",accessor:"getFillColor",pickingInfo:"colorValue",getBins:{triggers:{value:{prop:"getColorValue",updateTrigger:"getColorValue"},weight:{prop:"getColorWeight",updateTrigger:"getColorWeight"},aggregation:{prop:"colorAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"lowerPercentile"},upperPercentile:{prop:"upperPercentile"},scaleType:{prop:"colorScaleType"}}},getScaleFunc:{triggers:{domain:{prop:"colorDomain"},range:{prop:"colorRange"}},onSet:{props:"onSetColorDomain"}},nullValue:[0,0,0,0]},{key:"elevation",accessor:"getElevation",pickingInfo:"elevationValue",getBins:{triggers:{value:{prop:"getElevationValue",updateTrigger:"getElevationValue"},weight:{prop:"getElevationWeight",updateTrigger:"getElevationWeight"},aggregation:{prop:"elevationAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"elevationLowerPercentile"},upperPercentile:{prop:"elevationUpperPercentile"},scaleType:{prop:"elevationScaleType"}}},getScaleFunc:{triggers:{domain:{prop:"elevationDomain"},range:{prop:"elevationRange"}},onSet:{props:"onSetElevationDomain"}},nullValue:-1}],Be=function(e){return e.cellSize},Fe=function(){function e(t){u()(this,e),this.state={layerData:{},dimensions:{}},this.changeFlags={},this.dimensionUpdaters={},this._getCellSize=t.getCellSize||Be,this._getAggregator=t.getAggregator,this._addDimension(t.dimensions||Re)}return g()(e,[{key:"updateState",value:function(e,t){var n=e.oldProps,i=e.props,r=e.changeFlags;this.updateGetValueFuncs(n,i,r);var a=this.needsReProjectPoints(n,i,r),o=!1;r.dataChanged||a?(this.getAggregatedData(i,t),o=!0):((this.getDimensionChanges(n,i,r)||[]).forEach((function(e){return"function"==typeof e&&e()})),o=!0);return this.setState({aggregationDirty:o}),this.state}},{key:"setState",value:function(e){this.state=Object.assign({},this.state,e)}},{key:"setDimensionState",value:function(e,t){this.setState({dimensions:Object.assign({},this.state.dimensions,o()({},e,Object.assign({},this.state.dimensions[e],t)))})}},{key:"normalizeResult",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.hexagons?Object.assign({data:e.hexagons},e):e.layerData?Object.assign({data:e.layerData},e):e}},{key:"getAggregatedData",value:function(e,t){var n=this._getAggregator(e)(e,t);this.setState({layerData:this.normalizeResult(n)}),this.changeFlags={layerData:!0},this.getSortedBins(e)}},{key:"updateGetValueFuncs",value:function(e,t,n){for(var i in this.dimensionUpdaters){var r=this.dimensionUpdaters[i].getBins.triggers,a=r.value,o=r.weight,s=r.aggregation,u=t[a.prop];this.needUpdateDimensionStep(this.dimensionUpdaters[i].getBins,e,t,n)&&null===u&&(u=M(t[s.prop],t[o.prop])),u&&this.setDimensionState(i,{getValue:u})}}},{key:"needsReProjectPoints",value:function(e,t,n){return this._getCellSize(e)!==this._getCellSize(t)||this._getAggregator(e)!==this._getAggregator(t)||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPosition)}},{key:"addDimension",value:function(e){this._addDimension(e)}},{key:"_addDimension",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];t.forEach((function(t){var n=t.key;e.dimensionUpdaters[n]=e.getDimensionUpdaters(t),e.state.dimensions[n]={getValue:null,domain:null,sortedBins:null,scaleFunc:Ne}}))}},{key:"getDimensionUpdaters",value:function(e){var t=e.key,n=e.accessor,i=e.pickingInfo,r=e.getBins,a=e.getDomain,o=e.getScaleFunc,s=e.nullValue;return{key:t,accessor:n,pickingInfo:i,getBins:Object.assign({updater:this.getDimensionSortedBins},r),getDomain:Object.assign({updater:this.getDimensionValueDomain},a),getScaleFunc:Object.assign({updater:this.getDimensionScale},o),attributeAccessor:this.getSubLayerDimensionAttribute(t,s)}}},{key:"needUpdateDimensionStep",value:function(e,t,n,i){return Object.values(e.triggers).some((function(e){return e.updateTrigger?i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged[e.updateTrigger]):t[e.prop]!==n[e.prop]}))}},{key:"getDimensionChanges",value:function(e,t,n){var i=this,r=[],a=function(a){var o=je.find((function(r){return i.needUpdateDimensionStep(i.dimensionUpdaters[a][r],e,t,n)}));o&&r.push(i.dimensionUpdaters[a][o].updater.bind(i,t,i.dimensionUpdaters[a]))};for(var o in this.dimensionUpdaters)a(o);return r.length?r:null}},{key:"getUpdateTriggers",value:function(e){var t=this,n=e.updateTriggers||{},i={},r=function(r){var a=t.dimensionUpdaters[r].accessor;i[a]={},je.forEach((function(o){Object.values(t.dimensionUpdaters[r][o].triggers).forEach((function(t){var r=t.prop,o=t.updateTrigger;if(o){var s=n[o];"object"!==ze()(s)||Array.isArray(s)?void 0!==s&&(i[a][r]=s):Object.assign(i[a],s)}else i[a][r]=e[r]}))}))};for(var a in this.dimensionUpdaters)r(a);return i}},{key:"getSortedBins",value:function(e){for(var t in this.dimensionUpdaters)this.getDimensionSortedBins(e,this.dimensionUpdaters[t])}},{key:"getDimensionSortedBins",value:function(e,t){var n=t.key,i=this.state.dimensions[n].getValue,r=new Se(this.state.layerData.data||[],{getValue:i,filterData:e._filterData});this.setDimensionState(n,{sortedBins:r}),this.getDimensionValueDomain(e,t)}},{key:"getDimensionValueDomain",value:function(e,t){var n=t.getDomain,i=t.key,r=n.triggers,a=r.lowerPercentile,o=r.upperPercentile,s=r.scaleType,u=this.state.dimensions[i].sortedBins.getValueDomainByScale(e[s.prop],[e[a.prop],e[o.prop]]);this.setDimensionState(i,{valueDomain:u}),this.getDimensionScale(e,t)}},{key:"getDimensionScale",value:function(e,t){var n=t.key,i=t.getScaleFunc,r=t.getDomain,a=i.triggers,o=a.domain,s=a.range,u=r.triggers.scaleType,l=i.onSet,g=e[s.prop],c=e[o.prop]||this.state.dimensions[n].valueDomain,d=function(e){switch(e){case"quantize":return oe;case"linear":return se;case"quantile":return ue;case"ordinal":return ce;default:return oe}}(u&&e[u.prop])(c,g);"object"===ze()(l)&&"function"==typeof e[l.props]&&e[l.props](d.domain()),this.setDimensionState(n,{scaleFunc:d})}},{key:"getSubLayerDimensionAttribute",value:function(e,t){var n=this;return function(i){var r=n.state.dimensions[e],a=r.sortedBins,o=r.scaleFunc,s=a.binMap[i.index];if(s&&0===s.counts)return t;var u=s&&s.value,l=o.domain();return u>=l[0]&&u<=l[l.length-1]?o(u):t}}},{key:"getSubLayerAccessors",value:function(e){var t={};for(var n in this.dimensionUpdaters){t[this.dimensionUpdaters[n].accessor]=this.getSubLayerDimensionAttribute(e,n)}return t}},{key:"getPickingInfo",value:function(e){var t=e.info,n=null;if(t.picked&&t.index>-1){var i=this.state.layerData.data[t.index],r={};for(var a in this.dimensionUpdaters){var o=this.dimensionUpdaters[a].pickingInfo,s=this.state.dimensions[a].sortedBins,u=s.binMap[i.index]&&s.binMap[i.index].value;r[o]=u}n=Object.assign(r,i,{points:i.filteredPoints||i.points})}return Object.assign(t,{picked:Boolean(n),object:n})}},{key:"getAccessor",value:function(e){return this.dimensionUpdaters.hasOwnProperty(e)?this.dimensionUpdaters[e].attributeAccessor:Ne}}],[{key:"defaultDimensions",value:function(){return Re}}]),e}();function Ie(){}var We={colorDomain:null,colorRange:q,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",lowerPercentile:{type:"number",min:0,max:100,value:0},upperPercentile:{type:"number",min:0,max:100,value:100},colorScaleType:"quantize",onSetColorDomain:Ie,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",min:0,max:100,value:0},elevationUpperPercentile:{type:"number",min:0,max:100,value:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:Ie,gridAggregator:Pe,cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,material:!0,_filterData:{type:"function",value:null,optional:!0}},Ue=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(){var e=new Fe({getAggregator:function(e){return e.gridAggregator},getCellSize:function(e){return e.cellSize}});this.state={cpuAggregator:e,aggregatorState:e.state},this.getAttributeManager().add({positions:{size:3,accessor:"getPosition"}})}},{key:"updateState",value:function(e){v()(h()(t.prototype),"updateState",this).call(this,e),this.setState({aggregatorState:this.state.cpuAggregator.updateState(e,{viewport:this.context.viewport,attributes:this.getAttributes(),numInstances:this.getNumInstances(e.props)})})}},{key:"getPickingInfo",value:function(e){var t=e.info;return this.state.cpuAggregator.getPickingInfo({info:t})}},{key:"_onGetSublayerColor",value:function(e){return this.state.cpuAggregator.getAccessor("fillColor")(e)}},{key:"_onGetSublayerElevation",value:function(e){return this.state.cpuAggregator.getAccessor("elevation")(e)}},{key:"_getSublayerUpdateTriggers",value:function(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.extruded,i=e.cellSize,r=e.coverage,a=e.material,o=e.transitions,s=this.state.cpuAggregator,u=this.getSubLayerClass("grid-cell",x.GridCellLayer),l=this._getSublayerUpdateTriggers();return new u({cellSize:i,coverage:r,material:a,elevationScale:t,extruded:n,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:o&&{getFillColor:o.getColorValue||o.getColorWeight,getElevation:o.getElevationValue||o.getElevationWeight}},this.getSubLayerProps({id:"grid-cell",updateTriggers:l}),{data:s.state.layerData.data})}}]),t}(ne);Ue.layerName="CPUGridLayer",Ue.defaultProps=We;var Le=Math.PI/3,Ge=[0,Le,2*Le,3*Le,4*Le,5*Le];function Ve(e){return e[0]}function He(e){return e[1]}var Xe=function(){var e,t,n,i=0,r=0,a=1,o=1,s=Ve,u=He;function l(e){var i,r={},a=[],o=e.length;for(i=0;i<o;++i)if(!isNaN(g=+s.call(null,l=e[i],i,e))&&!isNaN(c=+u.call(null,l,i,e))){var l,g,c,d=Math.round(c/=n),f=Math.round(g=g/t-(1&d)/2),h=c-d;if(3*Math.abs(h)>1){var p=g-f,v=f+(g<f?-1:1)/2,m=d+(c<d?-1:1),y=g-v,x=c-m;p*p+h*h>y*y+x*x&&(f=v+(1&d?1:-1)/2,d=m)}var S=f+"-"+d,b=r[S];b?b.push(l):(a.push(b=r[S]=[l]),b.x=(f+(1&d)/2)*t,b.y=d*n)}return a}function g(e){var t=0,n=0;return Ge.map((function(i){var r=Math.sin(i)*e,a=-Math.cos(i)*e,o=r-t,s=a-n;return t=r,n=a,[o,s]}))}return l.hexagon=function(t){return"m"+g(null==t?e:+t).join("l")+"z"},l.centers=function(){for(var s=[],u=Math.round(r/n),l=Math.round(i/t),g=u*n;g<o+e;g+=n,++u)for(var c=l*t+(1&u)*t/2;c<a+t/2;c+=t)s.push([c,g]);return s},l.mesh=function(){var t=g(e).slice(0,4).join("l");return l.centers().map((function(e){return"M"+e+"m"+t})).join("")},l.x=function(e){return arguments.length?(s=e,l):s},l.y=function(e){return arguments.length?(u=e,l):u},l.radius=function(i){return arguments.length?(t=2*(e=+i)*Math.sin(Le),n=1.5*e,l):e},l.size=function(e){return arguments.length?(i=r=0,a=+e[0],o=+e[1],l):[a-i,o-r]},l.extent=function(e){return arguments.length?(i=+e[0][0],r=+e[0][1],a=+e[1][0],o=+e[1][1],l):[[i,r],[a,o]]},l.radius(1)};function Ye(){}var qe,Ke={colorDomain:null,colorRange:q,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",lowerPercentile:{type:"number",value:0,min:0,max:100},upperPercentile:{type:"number",value:100,min:0,max:100},colorScaleType:"quantize",onSetColorDomain:Ye,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",value:0,min:0,max:100},elevationUpperPercentile:{type:"number",value:100,min:0,max:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:Ye,radius:{type:"number",value:1e3,min:1},coverage:{type:"number",min:0,max:1,value:1},extruded:!1,hexagonAggregator:function(e,t){var n=e.data,i=e.radius,r=t.viewport,a=t.attributes,o=function(e,t){var n=t.getDistanceScales().unitsPerMeter;return e*n[0]}(i,r),s=[],u=Object(x.createIterable)(n),l=u.iterable,g=u.objectInfo,c=a.positions.value,d=a.positions.getAccessor().size,f=!0,h=!1,p=void 0;try{for(var v,m=l[Symbol.iterator]();!(f=(v=m.next()).done);f=!0){var y=v.value;g.index++;var S=g.index*d,b=[c[S],c[S+1]];Number.isFinite(b[0])&&Number.isFinite(b[1])?s.push(Object.assign({screenCoord:r.projectFlat(b)},y)):x.log.warn("HexagonLayer: invalid position")()}}catch(e){h=!0,p=e}finally{try{f||null==m.return||m.return()}finally{if(h)throw p}}return{hexagons:Xe().radius(o).x((function(e){return e.screenCoord[0]})).y((function(e){return e.screenCoord[1]}))(s).map((function(e,t){return{position:r.unprojectFlat([e.x,e.y]),points:e,index:t}}))}},getPosition:{type:"accessor",value:function(e){return e.position}},material:!0,_filterData:{type:"function",value:null,optional:!0}},Qe=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(){var e=new Fe({getAggregator:function(e){return e.hexagonAggregator},getCellSize:function(e){return e.radius}});this.state={cpuAggregator:e,aggregatorState:e.state},this.getAttributeManager().add({positions:{size:3,accessor:"getPosition"}})}},{key:"updateState",value:function(e){v()(h()(t.prototype),"updateState",this).call(this,e);var n=this.state.cpuAggregator,i=n.state.layerData;if(this.setState({aggregatorState:n.updateState(e,{viewport:this.context.viewport,attributes:this.getAttributes()})}),i!==n.state.layerData){var r=n.state.layerData.hexagonVertices;this.updateRadiusAngle(r)}}},{key:"updateRadiusAngle",value:function(e){var t=this.props.radius,n=90;if(Array.isArray(e)){e.length<6&&x.log.error("HexagonCellLayer: hexagonVertices needs to be an array of 6 points")();var i=e[0],r=e[3],a=this.context.viewport.getDistanceScales().unitsPerMeter,o=this.projectFlat(i),s=this.projectFlat(r),u=o[0]-s[0],l=o[1]-s[1],g=Math.sqrt(u*u+l*l);n=Math.acos(u/g)*-Math.sign(l)/Math.PI*180+90,t=g/2/a[0]}this.setState({angle:n,radius:t})}},{key:"getPickingInfo",value:function(e){var t=e.info;return this.state.cpuAggregator.getPickingInfo({info:t})}},{key:"_onGetSublayerColor",value:function(e){return this.state.cpuAggregator.getAccessor("fillColor")(e)}},{key:"_onGetSublayerElevation",value:function(e){return this.state.cpuAggregator.getAccessor("elevation")(e)}},{key:"_getSublayerUpdateTriggers",value:function(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.extruded,i=e.coverage,r=e.material,a=e.transitions,o=this.state,s=o.angle,u=o.radius,l=o.cpuAggregator,g=this.getSubLayerClass("hexagon-cell",x.ColumnLayer),c=this._getSublayerUpdateTriggers();return new g({radius:u,diskResolution:6,elevationScale:t,angle:s,extruded:n,coverage:i,material:r,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:a&&{getFillColor:a.getColorValue||a.getColorWeight,getElevation:a.getElevationValue||a.getElevationWeight}},this.getSubLayerProps({id:"hexagon-cell",updateTriggers:c}),{data:l.state.layerData.data})}}]),t}(ne);Qe.layerName="HexagonLayer",Qe.defaultProps=Ke;var Ze={N:[0,.5],E:[.5,0],S:[0,-.5],W:[-.5,0],NE:[.5,.5],NW:[-.5,.5],SE:[.5,-.5],SW:[-.5,-.5]},Je=[Ze.W,Ze.SW,Ze.S],$e=[Ze.S,Ze.SE,Ze.E],et=[Ze.E,Ze.NE,Ze.N],tt=[Ze.NW,Ze.W,Ze.N],nt=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5]],it=[[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6]],rt=[[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],at=[[-.5,1/6],[-.5,-1/6],[1/6,.5],[-1/6,.5]],ot=[Ze.W,Ze.SW,Ze.SE,Ze.E],st=[Ze.S,Ze.SE,Ze.NE,Ze.N],ut=[Ze.NW,Ze.W,Ze.E,Ze.NE],lt=[Ze.NW,Ze.SW,Ze.S,Ze.N],gt=[[-.5,1/6],[-.5,-1/6],[.5,-1/6],[.5,1/6]],ct=[[-1/6,-.5],[1/6,-.5],[1/6,.5],[-1/6,.5]],dt=[Ze.NW,Ze.SW,Ze.SE,Ze.NE],ft=[Ze.NW,Ze.SW,Ze.SE,Ze.E,Ze.N],ht=[Ze.W,Ze.SW,Ze.SE,Ze.NE,Ze.N],pt=[Ze.NW,Ze.W,Ze.S,Ze.SE,Ze.NE],vt=[Ze.NW,Ze.SW,Ze.S,Ze.E,Ze.NE],mt=[Ze.NW,Ze.W,[.5,-1/6],[.5,1/6],Ze.N],yt=[[-1/6,-.5],[1/6,-.5],Ze.E,Ze.NE,Ze.N],xt=[[-.5,1/6],[-.5,-1/6],Ze.S,Ze.SE,Ze.E],St=[Ze.W,Ze.SW,Ze.S,[1/6,.5],[-1/6,.5]],bt=[Ze.NW,Ze.W,[-1/6,-.5],[1/6,-.5],Ze.N],wt=[[-.5,1/6],[-.5,-1/6],Ze.E,Ze.NE,Ze.N],At=[Ze.S,Ze.SE,Ze.E,[1/6,.5],[-1/6,.5]],Ct=[Ze.W,Ze.SW,Ze.S,[.5,-1/6],[.5,1/6]],Mt=[Ze.W,Ze.SW,Ze.SE,Ze.E,[1/6,.5],[-1/6,.5]],Dt=[[-.5,1/6],[-.5,-1/6],Ze.S,Ze.SE,Ze.NE,Ze.N],Pt=[Ze.NW,Ze.W,[-1/6,-.5],[1/6,-.5],Ze.E,Ze.NE],Ot=[Ze.NW,Ze.SW,Ze.S,[.5,-1/6],[.5,1/6],Ze.N],Tt=[Ze.W,Ze.SW,Ze.S,Ze.E,Ze.NE,Ze.N],_t=[Ze.NW,Ze.W,Ze.S,Ze.SE,Ze.E,Ze.N],Et=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],Ze.E,Ze.NE,Ze.N],kt=[Ze.W,Ze.SW,Ze.S,[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],zt=[Ze.NW,Ze.W,[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],Ze.N],Nt=[[-.5,1/6],[-.5,-1/6],Ze.S,Ze.SE,Ze.E,[1/6,.5],[-1/6,.5]],jt=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],Rt={0:[],1:[[Ze.W,Ze.S]],2:[[Ze.S,Ze.E]],3:[[Ze.W,Ze.E]],4:[[Ze.N,Ze.E]],5:{0:[[Ze.W,Ze.S],[Ze.N,Ze.E]],1:[[Ze.W,Ze.N],[Ze.S,Ze.E]]},6:[[Ze.N,Ze.S]],7:[[Ze.W,Ze.N]],8:[[Ze.W,Ze.N]],9:[[Ze.N,Ze.S]],10:{0:[[Ze.W,Ze.N],[Ze.S,Ze.E]],1:[[Ze.W,Ze.S],[Ze.N,Ze.E]]},11:[[Ze.N,Ze.E]],12:[[Ze.W,Ze.E]],13:[[Ze.S,Ze.E]],14:[[Ze.W,Ze.S]],15:[]};function Bt(e){return parseInt(e,4)}var Ft=(qe={},o()(qe,Bt("0000"),[]),o()(qe,Bt("2222"),[]),o()(qe,Bt("2221"),[Je]),o()(qe,Bt("2212"),[$e]),o()(qe,Bt("2122"),[et]),o()(qe,Bt("1222"),[tt]),o()(qe,Bt("0001"),[Je]),o()(qe,Bt("0010"),[$e]),o()(qe,Bt("0100"),[et]),o()(qe,Bt("1000"),[tt]),o()(qe,Bt("2220"),[nt]),o()(qe,Bt("2202"),[it]),o()(qe,Bt("2022"),[rt]),o()(qe,Bt("0222"),[at]),o()(qe,Bt("0002"),[nt]),o()(qe,Bt("0020"),[it]),o()(qe,Bt("0200"),[rt]),o()(qe,Bt("2000"),[at]),o()(qe,Bt("0011"),[ot]),o()(qe,Bt("0110"),[st]),o()(qe,Bt("1100"),[ut]),o()(qe,Bt("1001"),[lt]),o()(qe,Bt("2211"),[ot]),o()(qe,Bt("2112"),[st]),o()(qe,Bt("1122"),[ut]),o()(qe,Bt("1221"),[lt]),o()(qe,Bt("2200"),[gt]),o()(qe,Bt("2002"),[ct]),o()(qe,Bt("0022"),[gt]),o()(qe,Bt("0220"),[ct]),o()(qe,Bt("1111"),[dt]),o()(qe,Bt("1211"),[ft]),o()(qe,Bt("2111"),[ht]),o()(qe,Bt("1112"),[pt]),o()(qe,Bt("1121"),[vt]),o()(qe,Bt("1011"),[ft]),o()(qe,Bt("0111"),[ht]),o()(qe,Bt("1110"),[pt]),o()(qe,Bt("1101"),[vt]),o()(qe,Bt("1200"),[mt]),o()(qe,Bt("0120"),[yt]),o()(qe,Bt("0012"),[xt]),o()(qe,Bt("2001"),[St]),o()(qe,Bt("1022"),[mt]),o()(qe,Bt("2102"),[yt]),o()(qe,Bt("2210"),[xt]),o()(qe,Bt("0221"),[St]),o()(qe,Bt("1002"),[bt]),o()(qe,Bt("2100"),[wt]),o()(qe,Bt("0210"),[At]),o()(qe,Bt("0021"),[Ct]),o()(qe,Bt("1220"),[bt]),o()(qe,Bt("0122"),[wt]),o()(qe,Bt("2012"),[At]),o()(qe,Bt("2201"),[Ct]),o()(qe,Bt("0211"),[Mt]),o()(qe,Bt("2110"),[Dt]),o()(qe,Bt("1102"),[Pt]),o()(qe,Bt("1021"),[Ot]),o()(qe,Bt("2011"),[Mt]),o()(qe,Bt("0112"),[Dt]),o()(qe,Bt("1120"),[Pt]),o()(qe,Bt("1201"),[Ot]),o()(qe,Bt("2101"),[Tt]),o()(qe,Bt("0121"),[Tt]),o()(qe,Bt("1012"),[_t]),o()(qe,Bt("1210"),[_t]),o()(qe,Bt("0101"),{0:[Je,et],1:[Tt],2:[Tt]}),o()(qe,Bt("1010"),{0:[tt,$e],1:[_t],2:[_t]}),o()(qe,Bt("2121"),{0:[Tt],1:[Tt],2:[Je,et]}),o()(qe,Bt("1212"),{0:[_t],1:[_t],2:[tt,$e]}),o()(qe,Bt("2120"),{0:[Et],1:[Et],2:[nt,et]}),o()(qe,Bt("2021"),{0:[kt],1:[kt],2:[Je,rt]}),o()(qe,Bt("1202"),{0:[zt],1:[zt],2:[tt,it]}),o()(qe,Bt("0212"),{0:[Nt],1:[Nt],2:[$e,at]}),o()(qe,Bt("0102"),{0:[nt,et],1:[Et],2:[Et]}),o()(qe,Bt("0201"),{0:[Je,rt],1:[kt],2:[kt]}),o()(qe,Bt("1020"),{0:[tt,it],1:[zt],2:[zt]}),o()(qe,Bt("2010"),{0:[$e,at],1:[Nt],2:[Nt]}),o()(qe,Bt("2020"),{0:[at,it],1:[jt],2:[nt,rt]}),o()(qe,Bt("0202"),{0:[rt,nt],1:[jt],2:[at,it]}),qe),It={ISO_LINES:1,ISO_BANDS:2},Wt={zIndex:0,zOffset:.005};function Ut(e,t){return Array.isArray(t)?e<t[0]?0:e<t[1]?1:2:e>=t?1:0}function Lt(e){var t=e.cellWeights,n=e.x,i=e.y,r=e.width,a=e.height,o=e.threshold;e.thresholdValue&&(x.log.deprecated("thresholdValue","threshold")(),o=e.thresholdValue);var s=n<0,u=n>=r-1,l=i<0,g=i>=a-1,c=s||u||l||g,d={},f={};s||g?f.top=0:(d.top=t[(i+1)*r+n],f.top=Ut(d.top,o)),u||g?f.topRight=0:(d.topRight=t[(i+1)*r+n+1],f.topRight=Ut(d.topRight,o)),u||l?f.right=0:(d.right=t[i*r+n+1],f.right=Ut(d.right,o)),s||l?f.current=0:(d.current=t[i*r+n],f.current=Ut(d.current,o));var h=f.top,p=f.topRight,v=f.right,m=f.current,y=-1;Number.isFinite(o)&&(y=h<<3|p<<2|v<<1|m),Array.isArray(o)&&(y=h<<6|p<<4|v<<2|m);var S=0;return c||(S=Ut((d.top+d.topRight+d.right+d.current)/4,o)),{code:y,meanCode:S}}function Gt(e){var t=e.gridOrigin,n=e.cellSize,i=e.x,r=e.y,a=e.code,o=e.meanCode,s=e.type,u=void 0===s?It.ISO_LINES:s,l=Object.assign({},Wt,e.thresholdData),g=u===It.ISO_BANDS?Ft[a]:Rt[a];Array.isArray(g)||(g=g[o]);var c=l.zIndex*l.zOffset,d=(i+1)*n[0],f=(r+1)*n[1],h=t[0]+d,p=t[1]+f;if(u===It.ISO_BANDS){var v=[];return g.forEach((function(e){var t=[];e.forEach((function(e){var i=h+e[0]*n[0],r=p+e[1]*n[1];t.push([i,r,c])})),v.push(t)})),v}var m=[];return g.forEach((function(e){e.forEach((function(e){var t=h+e[0]*n[0],i=p+e[1]*n[1];m.push([t,i,c])}))})),m}var Vt=[255,255,255,255],Ht={cellSize:{type:"number",min:1,max:1e3,value:1e3},getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return 1}},gpuAggregation:!0,aggregation:"SUM",contours:[{threshold:1}],zOffset:.005},Xt={data:{props:["cellSize"]},weights:{props:["aggregation"],accessors:["getWeight"]}},Yt=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(){var e;v()(h()(t.prototype),"initializeState",this).call(this,{dimensions:Xt}),this.setState({contourData:{},projectPoints:!1,weights:{count:{size:1,operation:b.SUM}}}),this.getAttributeManager().add((e={},o()(e,"positions",{size:3,accessor:"getPosition",type:5130,fp64:this.use64bitPositions()}),o()(e,"count",{size:3,accessor:"getWeight"}),e))}},{key:"updateState",value:function(e){v()(h()(t.prototype),"updateState",this).call(this,e);var n=!1,i=e.oldProps,r=e.props,a=this.state.aggregationDirty;i.contours===r.contours&&i.zOffset===r.zOffset||(n=!0,this._updateThresholdData(e.props)),this.getNumInstances()>0&&(a||n)&&this._generateContours()}},{key:"renderLayers",value:function(){var e=this.state.contourData,t=e.contourSegments,n=e.contourPolygons,i=this.getSubLayerClass("lines",x.LineLayer),r=this.getSubLayerClass("bands",x.SolidPolygonLayer);return[t&&t.length>0&&new i(this.getSubLayerProps({id:"lines"}),{data:this.state.contourData.contourSegments,getSourcePosition:function(e){return e.start},getTargetPosition:function(e){return e.end},getColor:function(e){return e.contour.color||Vt},getWidth:function(e){return e.contour.strokeWidth||1}}),n&&n.length>0&&new r(this.getSubLayerProps({id:"bands"}),{data:this.state.contourData.contourPolygons,getPolygon:function(e){return e.vertices},getFillColor:function(e){return e.contour.color||Vt}})]}},{key:"updateAggregationState",value:function(e){var t=e.props,n=e.oldProps,i=t.cellSize,r=t.coordinateSystem,a=this.context.viewport,o=n.cellSize!==i,s=t.gpuAggregation;this.state.gpuAggregation!==t.gpuAggregation&&s&&!H.isSupported(this.context.gl)&&(x.log.warn("GPU Grid Aggregation not supported, falling back to CPU")(),s=!1);var u=s!==this.state.gpuAggregation;this.setState({gpuAggregation:s});var l=this.state.dimensions,g=this.isAttributeChanged("positions"),c=l.data,d=l.weights,f=this.state.boundingBox;if(g&&(f=Ae(this.getAttributes(),this.getNumInstances()),this.setState({boundingBox:f})),g||o){var h=De(f,i,a,r),p=h.gridOffset,v=h.translation,m=h.width,y=h.height,S=h.numCol,b=h.numRow;this.allocateResources(b,S),this.setState({gridOffset:p,boundingBox:f,translation:v,posOffset:v.slice(),gridOrigin:[-1*v[0],-1*v[1]],width:m,height:y,numCol:S,numRow:b})}var w=g||u||this.isAggregationDirty(e,{dimension:c,compareAll:s}),A=this.isAggregationDirty(e,{dimension:d});A&&this._updateAccessors(e),(w||A)&&this._resetResults(),this.setState({aggregationDataDirty:w,aggregationWeightsDirty:A})}},{key:"_updateAccessors",value:function(e){var t=e.props,n=t.getWeight,i=t.aggregation,r=this.state.weights.count;r&&(r.getWeight=n,r.operation=b[i]),this.setState({getValue:M(i,n)})}},{key:"_resetResults",value:function(){var e=this.state.weights.count;e&&(e.aggregationData=null)}},{key:"_generateContours",value:function(){var e=this.state,t=e.numCol,n=e.numRow,i=e.gridOrigin,r=e.gridOffset,a=e.thresholdData,o=this.state.weights.count,s=o.aggregationData;s||(s=o.aggregationBuffer.getData(),o.aggregationData=s);var u=function(e){var t=e.thresholdData,n=(e.colors,e.cellWeights),i=e.gridSize,r=e.gridOrigin,a=e.cellSize,o=[],s=[],u=i[0],l=i[1],g=0,c=0,d=!0,f=!1,h=void 0;try{for(var p,v=t[Symbol.iterator]();!(d=(p=v.next()).done);d=!0)for(var m=p.value,y=m.contour,x=y.threshold,S=-1;S<u;S++)for(var b=-1;b<l;b++){var w=Lt({cellWeights:n,threshold:x,x:S,y:b,width:u,height:l}),A={gridOrigin:r,cellSize:a,x:S,y:b,width:u,height:l,code:w.code,meanCode:w.meanCode,thresholdData:m};if(Array.isArray(x)){A.type=It.ISO_BANDS;var C=Gt(A),M=!0,D=!1,P=void 0;try{for(var O,T=C[Symbol.iterator]();!(M=(O=T.next()).done);M=!0){var _=O.value;s[c++]={vertices:_,contour:y}}}catch(e){D=!0,P=e}finally{try{M||null==T.return||T.return()}finally{if(D)throw P}}}else{A.type=It.ISO_LINES;for(var E=Gt(A),k=0;k<E.length;k+=2)o[g++]={start:E[k],end:E[k+1],contour:y}}}}catch(e){f=!0,h=e}finally{try{d||null==v.return||v.return()}finally{if(f)throw h}}return{contourSegments:o,contourPolygons:s}}({thresholdData:a,cellWeights:H.getCellData({countsData:s}).cellWeights,gridSize:[t,n],gridOrigin:i,cellSize:[r.xOffset,r.yOffset]});this.setState({contourData:u})}},{key:"_updateThresholdData",value:function(e){for(var t=e.contours,n=e.zOffset,i=t.length,r=new Array(i),a=0;a<i;a++){var o=t[a];r[a]={contour:o,zIndex:o.zIndex||a,zOffset:n}}this.setState({thresholdData:r})}}]),t}(Oe);Yt.layerName="ContourLayer",Yt.defaultProps=Ht;var qt={colorDomain:null,colorRange:q,elevationDomain:null,elevationRange:[0,1e3],elevationScale:{type:"number",min:0,value:1},gridSize:{type:"array",min:0,value:[1,1]},gridOrigin:{type:"array",min:0,value:[0,0]},gridOffset:{type:"array",min:0,value:[0,0]},cellSize:{type:"number",min:0,max:1e3,value:1e3},offset:{type:"array",min:0,value:[1,1]},coverage:{type:"number",min:0,max:1,value:1},extruded:!0,material:!0},Kt=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"getShaders",value:function(){return v()(h()(t.prototype),"getShaders",this).call(this,{vs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-vertex-shader\n#define RANGE_COUNT 6\n\nin vec3 positions;\nin vec3 normals;\n\nin vec4 colors;\nin vec4 elevations;\nin vec3 instancePickingColors;\nuniform vec2 offset;\nuniform bool extruded;\nuniform float cellSize;\nuniform float coverage;\nuniform float opacity;\nuniform float elevationScale;\n\nuniform ivec2 gridSize;\nuniform vec2 gridOrigin;\nuniform vec2 gridOriginLow;\nuniform vec2 gridOffset;\nuniform vec2 gridOffsetLow;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 elevationRange;\nuniform vec2 colorDomain;\nuniform bool colorDomainValid;\nuniform vec2 elevationDomain;\nuniform bool elevationDomainValid;\n\nlayout(std140) uniform;\nuniform ColorData\n{\n  vec4 maxMinCount;\n} colorData;\nuniform ElevationData\n{\n  vec4 maxMinCount;\n} elevationData;\n\n#define EPSILON 0.00001\nout vec4 vColor;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  return outColor;\n}\n\nfloat linearScale(vec2 domain, vec2 range, float value) {\n  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {\n    return ((value - domain.x) / (domain.y - domain.x)) * (range.y - range.x) + range.x;\n  }\n  return -1.;\n}\n\nvoid main(void) {\n\n  vec2 clrDomain = colorDomainValid ? colorDomain : vec2(colorData.maxMinCount.a, colorData.maxMinCount.r);\n  vec4 color = quantizeScale(clrDomain, colorRange, colors.r);\n\n  float elevation = 0.0;\n\n  if (extruded) {\n    vec2 elvDomain = elevationDomainValid ? elevationDomain : vec2(elevationData.maxMinCount.a, elevationData.maxMinCount.r);\n    elevation = linearScale(elvDomain, elevationRange, elevations.r);\n    elevation = elevation  * (positions.z + 1.0) / 2.0 * elevationScale;\n  }\n  float shouldRender = float(color.r > 0.0 && elevations.r >= 0.0);\n  float dotRadius = cellSize / 2. * coverage * shouldRender;\n\n  int yIndex = (gl_InstanceID / gridSize[0]);\n  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);\n\n  vec2 instancePositionXFP64 = mul_fp64(vec2(gridOffset[0], gridOffsetLow[0]), vec2(float(xIndex), 0.));\n  instancePositionXFP64 = sum_fp64(instancePositionXFP64, vec2(gridOrigin[0], gridOriginLow[0]));\n  vec2 instancePositionYFP64 = mul_fp64(vec2(gridOffset[1], gridOffsetLow[1]), vec2(float(yIndex), 0.));\n  instancePositionYFP64 = sum_fp64(instancePositionYFP64, vec2(gridOrigin[1], gridOriginLow[1]));\n\n  vec3 centroidPosition = vec3(instancePositionXFP64[0], instancePositionYFP64[0], elevation);\n  vec3 centroidPosition64Low = vec3(instancePositionXFP64[1], instancePositionYFP64[1], 0.0);\n  vec3 pos = vec3(project_size(positions.xy + offset) * dotRadius, 0.);\n  picking_setPickingColor(instancePickingColors);\n\n  vec4 position_commonspace;\n  gl_Position = project_position_to_clipspace(centroidPosition, centroidPosition64Low, pos, position_commonspace);\n\n  vec3 normals_commonspace = project_normal(normals);\n\n   if (extruded) {\n    vec3 lightColor = lighting_getLightColor(color.rgb, project_uCameraPosition, position_commonspace.xyz, normals_commonspace);\n    vColor = vec4(lightColor, color.a * opacity) / 255.;\n  } else {\n    vColor = vec4(color.rgb, color.a * opacity) / 255.;\n  }\n}\n",fs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  fragColor = vColor;\n  fragColor = picking_filterColor(fragColor);\n}\n",modules:[x.project32,x.gouraudLighting,x.picking,S.fp64]})}},{key:"initializeState",value:function(){var e=this.context.gl;this.getAttributeManager().addInstanced({colors:{size:4,noAlloc:!0},elevations:{size:4,noAlloc:!0}});var t=this._getModel(e);this._setupUniformBuffer(t),this.setState({model:t})}},{key:"_getModel",value:function(e){return new S.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new S.CubeGeometry,isInstanced:!0}))}},{key:"draw",value:function(e){var t=e.uniforms,n=this.props,i=n.cellSize,r=n.offset,a=n.extruded,o=n.elevationScale,s=n.coverage,u=n.gridSize,l=n.gridOrigin,g=n.gridOffset,c=n.elevationRange,d=n.colorMaxMinBuffer,f=n.elevationMaxMinBuffer,h=[Object(x.fp64LowPart)(l[0]),Object(x.fp64LowPart)(l[1])],p=[Object(x.fp64LowPart)(g[0]),Object(x.fp64LowPart)(g[1])],v=this.getDomainUniforms(),m=K(this.props.colorRange);this.bindUniformBuffers(d,f),this.state.model.setUniforms(Object.assign({},t,v,{cellSize:i,offset:r,extruded:a,elevationScale:o,coverage:s,gridSize:u,gridOrigin:l,gridOriginLow:h,gridOffset:g,gridOffsetLow:p,colorRange:m,elevationRange:c})).draw(),this.unbindUniformBuffers(d,f)}},{key:"bindUniformBuffers",value:function(e,t){e.bind({target:35345,index:0}),t.bind({target:35345,index:1})}},{key:"unbindUniformBuffers",value:function(e,t){e.unbind({target:35345,index:0}),t.unbind({target:35345,index:1})}},{key:"getDomainUniforms",value:function(){var e=this.props,t=e.colorDomain,n=e.elevationDomain,i={};return null!==t?(i.colorDomainValid=!0,i.colorDomain=t):i.colorDomainValid=!1,null!==n?(i.elevationDomainValid=!0,i.elevationDomain=n):i.elevationDomainValid=!1,i}},{key:"_setupUniformBuffer",value:function(e){var t=this.context.gl,n=e.program.handle,i=t.getUniformBlockIndex(n,"ColorData"),r=t.getUniformBlockIndex(n,"ElevationData");t.uniformBlockBinding(n,i,0),t.uniformBlockBinding(n,r,1)}}]),t}(x.Layer);Kt.layerName="GPUGridCellLayer",Kt.defaultProps=qt;var Qt={colorDomain:null,colorRange:q,getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",elevationDomain:null,elevationRange:[0,1e3],getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationScale:{type:"number",min:0,value:1},cellSize:{type:"number",min:1,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,material:!0},Zt={data:{props:["cellSize","colorAggregation","elevationAggregation"]}},Jt=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(){var e,n=this.context.gl,i=H.isSupported(n);i||x.log.error("GPUGridLayer is not supported on this browser, use GridLayer instead")(),v()(h()(t.prototype),"initializeState",this).call(this,{dimensions:Zt}),this.setState({gpuAggregation:!0,projectPoints:!1,isSupported:i,weights:{color:{needMin:!0,needMax:!0,combineMaxMin:!0,maxMinBuffer:new S.Buffer(n,{byteLength:16,accessor:{size:4,type:5126,divisor:1}})},elevation:{needMin:!0,needMax:!0,combineMaxMin:!0,maxMinBuffer:new S.Buffer(n,{byteLength:16,accessor:{size:4,type:5126,divisor:1}})}},positionAttributeName:"positions"}),this.getAttributeManager().add((e={},o()(e,"positions",{size:3,accessor:"getPosition",type:5130,fp64:this.use64bitPositions()}),o()(e,"color",{size:3,accessor:"getColorWeight"}),o()(e,"elevation",{size:3,accessor:"getElevationWeight"}),e))}},{key:"updateState",value:function(e){!1!==this.state.isSupported&&(v()(h()(t.prototype),"updateState",this).call(this,e),this.state.aggregationDirty&&this.setState({gridHash:null}))}},{key:"getHashKeyForIndex",value:function(e){var t=this.state,n=t.numRow,i=t.numCol,r=t.boundingBox,a=t.gridOffset,o=[i,n],s=[r.xMin,r.yMin],u=[a.xOffset,a.yOffset],l=Math.floor(e/o[0]),g=e-l*o[0],c=Math.floor((l*u[1]+s[1]+90+u[1]/2)/u[1]),d=Math.floor((g*u[0]+s[0]+180+u[0]/2)/u[0]);return"".concat(c,"-").concat(d)}},{key:"getPositionForIndex",value:function(e){var t=this.state,n=t.numRow,i=t.numCol,r=t.boundingBox,a=t.gridOffset,o=[i,n],s=[r.xMin,r.yMin],u=[a.xOffset,a.yOffset],l=Math.floor(e/o[0]);return[(e-l*o[0])*u[0]+s[0],l*u[1]+s[1]]}},{key:"getPickingInfo",value:function(e){var t=e.info,n=e.mode,i=t.index,r=null;if(i>=0){var a=this.state.gpuGridAggregator,o=this.getPositionForIndex(i),s=H.getAggregationData(Object.assign({pixelIndex:i},a.getData("color"))),u=H.getAggregationData(Object.assign({pixelIndex:i},a.getData("elevation")));if(r={colorValue:s.cellWeight,elevationValue:u.cellWeight,count:s.cellCount||u.cellCount,position:o,totalCount:s.totalCount||u.totalCount},"hover"!==n){var l=this.props,g=this.state.gridHash;if(!g){var c=this.state,d=c.gridOffset,f=c.translation,h=c.boundingBox,p=this.context.viewport;g=Pe(l,{gridOffset:d,attributes:this.getAttributes(),viewport:p,translation:f,boundingBox:h}).gridHash,this.setState({gridHash:g})}var v=g[this.getHashKeyForIndex(i)];Object.assign(r,v)}}return Object.assign(t,{picked:Boolean(r),object:r})}},{key:"renderLayers",value:function(){if(!this.state.isSupported)return null;var e=this.props,t=e.elevationScale,n=e.extruded,i=e.cellSize,r=e.coverage,a=e.material,o=e.elevationRange,s=e.colorDomain,u=e.elevationDomain,l=this.state,g=l.weights,c=l.numRow,d=l.numCol,f=l.gridOrigin,h=l.gridOffset,p=g.color,v=g.elevation,m=K(this.props.colorRange);return new(this.getSubLayerClass("gpu-grid-cell",Kt))({gridSize:[d,c],gridOrigin:f,gridOffset:[h.xOffset,h.yOffset],colorRange:m,elevationRange:o,colorDomain:s,elevationDomain:u,cellSize:i,coverage:r,material:a,elevationScale:t,extruded:n},this.getSubLayerProps({id:"gpu-grid-cell"}),{data:{attributes:{colors:p.aggregationBuffer,elevations:v.aggregationBuffer}},colorMaxMinBuffer:p.maxMinBuffer,elevationMaxMinBuffer:v.maxMinBuffer,numInstances:d*c})}},{key:"finalizeState",value:function(){var e=this.state.weights;[e.color,e.elevation].forEach((function(e){var t=e.aggregationBuffer;e.maxMinBuffer.delete(),t&&t.delete()})),v()(h()(t.prototype),"finalizeState",this).call(this)}},{key:"updateAggregationState",value:function(e){var t=e.props,n=e.oldProps,i=t.cellSize,r=t.coordinateSystem,a=this.context.viewport,o=n.cellSize!==i,s=this.state.dimensions,u=this.isAttributeChanged("positions"),l=u||this.isAttributeChanged(),g=this.state.boundingBox;if(u&&(g=Ae(this.getAttributes(),this.getNumInstances()),this.setState({boundingBox:g})),u||o){var c=De(g,i,a,r),d=c.gridOffset,f=c.translation,h=c.width,p=c.height,v=c.numCol,m=c.numRow;this.allocateResources(m,v),this.setState({gridOffset:d,translation:f,gridOrigin:[-1*f[0],-1*f[1]],width:h,height:p,numCol:v,numRow:m})}var y=l||this.isAggregationDirty(e,{dimension:s.data,compareAll:!0});y&&this._updateAccessors(e),this.setState({aggregationDataDirty:y})}},{key:"_updateAccessors",value:function(e){var t=e.props,n=t.colorAggregation,i=t.elevationAggregation,r=this.state.weights,a=r.color,o=r.elevation;a.operation=b[n],o.operation=b[i]}}]),t}(Oe);Jt.layerName="GPUGridLayer",Jt.defaultProps=Qt;var $t=Object.assign({},Jt.defaultProps,Ue.defaultProps,{gpuAggregation:!1}),en=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(){this.state={useGPUAggregation:!0}}},{key:"updateState",value:function(e){e.oldProps;var t=e.props,n=(e.changeFlags,{});n.useGPUAggregation=this.canUseGPUAggregation(t),this.setState(n)}},{key:"renderLayers",value:function(){var e=this.props,t=e.data,n=e.updateTriggers,i=this.state.useGPUAggregation?"GPU":"CPU";return new(this.state.useGPUAggregation?this.getSubLayerClass("GPU",Jt):this.getSubLayerClass("CPU",Ue))(this.props,this.getSubLayerProps({id:i,updateTriggers:n}),{data:t})}},{key:"canUseGPUAggregation",value:function(e){var t=e.gpuAggregation,n=e.lowerPercentile,i=e.upperPercentile,r=e.getColorValue,a=e.getElevationValue,o=e.colorScaleType;return!!t&&(!!H.isSupported(this.context.gl)&&(0===n&&100===i&&(null===r&&null===a&&("quantile"!==o&&"ordinal"!==o))))}}]),t}(x.CompositeLayer);function tn(e){var t=e.map((function(e){return e[0]})),n=e.map((function(e){return e[1]})),i=Math.min.apply(null,t),r=Math.max.apply(null,t);return[i,Math.min.apply(null,n),r,Math.max.apply(null,n)]}function nn(e,t){return t[0]>=e[0]&&t[2]<=e[2]&&t[1]>=e[1]&&t[3]<=e[3]}en.layerName="GridLayer",en.defaultProps=$t;var rn=new Float32Array(12);function an(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=0,i=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done);i=!0)for(var u=o.value,l=0;l<t;l++)rn[n++]=u[l]||0}catch(e){r=!0,a=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw a}}return rn}function on(e,t,n){var i=re()(e,4),r=i[0],a=i[1],o=i[2],s=i[3],u=o-r,l=s-a,g=u,c=l;u/l<t/n?g=t/n*l:c=n/t*u,g<t&&(g=t,c=n);var d=(o+r)/2,f=(s+a)/2;return[d-g/2,f-c/2,d+g/2,f+c/2]}function sn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}var un=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"getShaders",value:function(){return{vs:"#define SHADER_NAME heatp-map-layer-vertex-shader\n\nuniform sampler2D maxTexture;\nuniform float intensity;\nuniform vec2 colorDomain;\nuniform float threshold;\n\nattribute vec3 positions;\nattribute vec2 texCoords;\n\nvarying vec2 vTexCoords;\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvoid main(void) {\n  gl_Position = project_position_to_clipspace(positions, vec3(0.0), vec3(0.0));\n  vTexCoords = texCoords;\n  float maxValue = texture2D(maxTexture, vec2(0.5)).r;\n  float minValue = maxValue * threshold;\n  if (colorDomain[1] > 0.) {\n    maxValue = colorDomain[1];\n    minValue = colorDomain[0];\n  }\n  vIntensityMax = intensity / maxValue;\n  vIntensityMin = intensity / minValue;\n}\n",fs:"#define SHADER_NAME triangle-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D texture;\nvarying vec2 vTexCoords;\nuniform sampler2D colorTexture;\n\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvec4 getLinearColor(float value) {\n  float factor = clamp(value * vIntensityMax, 0., 1.);\n  vec4 color = texture2D(colorTexture, vec2(factor, 0.5));\n  color.a *= min(value * vIntensityMin, 1.0);\n  return color;\n}\n\nvoid main(void) {\n  float weight = texture2D(texture, vTexCoords).r;\n  if (weight <= 0.) {\n     discard;\n  }\n\n  vec4 linearColor = getLinearColor(weight);\n  linearColor.a *= opacity;\n  gl_FragColor =linearColor;\n}\n",modules:[x.project32]}}},{key:"initializeState",value:function(){var e=this.context.gl;this.getAttributeManager().add({positions:{size:3,noAlloc:!0},texCoords:{size:2,noAlloc:!0}}),this.setState({model:this._getModel(e)})}},{key:"_getModel",value:function(e){var t=this.props.vertexCount;return new S.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new S.Geometry({drawMode:6,vertexCount:t})}))}},{key:"draw",value:function(e){var t=e.uniforms,n=this.state.model,i=this.props,r=i.texture,a=i.maxTexture,s=i.colorTexture,u=i.intensity,l=i.threshold,g=i.colorDomain;n.setUniforms(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sn(n,!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sn(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t,{texture:r,maxTexture:a,colorTexture:s,intensity:u,threshold:l,colorDomain:g})).draw()}}]),t}(x.Layer);un.layerName="TriangleLayer",un.defaultProps={count:0,texture:null};var ln,gn="attribute vec3 positions;\nattribute float weights;\nvarying vec4 weightsTexture;\nuniform float radiusPixels;\nuniform float textureWidth;\nuniform vec4 commonBounds;\nuniform float weightsScale;\nvoid main()\n{\n  weightsTexture = vec4(weights * weightsScale, 0., 0., 1.);\n\n  float radiusTexels  = project_pixel_size(radiusPixels) * textureWidth / (commonBounds.z - commonBounds.x);\n  gl_PointSize = radiusTexels * 2.;\n\n  vec3 commonPosition = project_position(positions);\n  gl_Position.xy = (commonPosition.xy - commonBounds.xy) / (commonBounds.zw - commonBounds.xy) ;\n  gl_Position.xy = (gl_Position.xy * 2.) - (1.);\n}\n",cn="varying vec4 weightsTexture;\nfloat gaussianKDE(float u){\n  return pow(2.71828, -u*u/0.05555)/(1.77245385*0.166666);\n}\nvoid main()\n{\n  float dist = length(gl_PointCoord - vec2(0.5, 0.5));\n  if (dist > 0.5) {\n    discard;\n  }\n  gl_FragColor.rgb = weightsTexture.rgb * gaussianKDE(2. * dist);\n  gl_FragColor.a = 1.0;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";function dn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function fn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?dn(n,!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):dn(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var hn={mipmaps:!1,parameters:(ln={},o()(ln,10240,9729),o()(ln,10241,9729),o()(ln,10242,33071),o()(ln,10243,33071),ln),dataFormat:6408},pn=[0,0],vn={getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:50},colorRange:q,threshold:{type:"number",min:0,max:1,value:.05},colorDomain:{type:"array",value:null,optional:!0}},mn=[S.FEATURES.BLEND_EQUATION_MINMAX,S.FEATURES.TEXTURE_FLOAT],yn={data:{props:["radiusPixels"]}},xn=function(e){function t(){return u()(this,t),d()(this,h()(t).apply(this,arguments))}return y()(t,e),g()(t,[{key:"initializeState",value:function(){var e=this.context.gl;if(!Object(S.hasFeatures)(e,mn))return this.setState({supported:!1}),void x.log.error("HeatmapLayer: ".concat(this.id," is not supported on this browser"))();v()(h()(t.prototype),"initializeState",this).call(this,yn),this.setState({supported:!0}),this._setupTextureParams(),this._setupAttributes(),this._setupResources()}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){if(this.state.supported){v()(h()(t.prototype),"updateState",this).call(this,e);var n=e.props,i=e.oldProps,r=this._getChangeFlags(e);if(r.viewportChanged&&(r.boundsChanged=this._updateBounds()),r.dataChanged||r.boundsChanged?this._updateWeightmap():r.viewportZoomChanged&&this._debouncedUpdateWeightmap(),n.colorRange!==i.colorRange&&this._updateColorTexture(e),r.viewportChanged&&this._updateTextureRenderingBounds(),i.colorDomain!==n.colorDomain||r.viewportChanged){var a=this.context.viewport,o=this.state.weightsScale,s=(a?1024/a.scale:1)*o,u=n.colorDomain?n.colorDomain.map((function(e){return e*s})):pn;if(u[1]>0&&o<1){var l=Math.min(u[1],1);u[0]*=l/u[1],u[1]=l}this.setState({colorDomain:u})}this.setState({zoom:e.context.viewport.zoom})}}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var e=this.state,t=e.weightsTexture,n=e.triPositionBuffer,i=e.triTexCoordBuffer,r=e.maxWeightsTexture,a=e.colorTexture,o=e.colorDomain,s=this.props,u=s.updateTriggers,l=s.intensity,g=s.threshold;return new(this.getSubLayerClass("triangle",un))(this.getSubLayerProps({id:"triangle-layer",updateTriggers:u}),{data:{attributes:{positions:n,texCoords:i}},vertexCount:4,maxTexture:r,colorTexture:a,texture:t,intensity:l,threshold:g,colorDomain:o})}},{key:"finalizeState",value:function(){v()(h()(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.weightsTransform,i=e.weightsTexture,r=e.maxWeightTransform,a=e.maxWeightsTexture,o=e.triPositionBuffer,s=e.triTexCoordBuffer,u=e.colorTexture,l=e.updateTimer;n&&n.delete(),i&&i.delete(),r&&r.delete(),a&&a.delete(),o&&o.delete(),s&&s.delete(),u&&u.delete(),l&&clearTimeout(l)}},{key:"_getAttributeManager",value:function(){return new x.AttributeManager(this.context.gl,{id:this.props.id,stats:this.context.stats})}},{key:"_getChangeFlags",value:function(e){var t={},n=this.state.dimensions;t.dataChanged=this.isAttributeChanged()||this.isAggregationDirty(e,{compareAll:!0,dimension:n.data}),t.viewportChanged=e.changeFlags.viewportChanged;var i=this.state.zoom;return e.context.viewport&&e.context.viewport.zoom===i||(t.viewportZoomChanged=!0),t}},{key:"_createTextures",value:function(){var e=this.context.gl,t=this.state,n=t.textureSize,i=t.format,r=t.type;this.setState({weightsTexture:new S.Texture2D(e,fn({width:n,height:n,format:i,type:r},hn)),maxWeightsTexture:new S.Texture2D(e,fn({format:i,type:r},hn))})}},{key:"_setupAttributes",value:function(){this.getAttributeManager().add({positions:{size:3,accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}}),this.setState({positionAttributeName:"positions"})}},{key:"_setupTextureParams",value:function(){var e=this.context.gl,t=Math.min(2048,Object(S.getParameters)(e,3379)),n=Object(S.hasFeatures)(e,S.FEATURES.COLOR_ATTACHMENT_RGBA32F),i=function(e){var t=e.gl,n=e.floatTargetSupport;return{format:Object(S.isWebGL2)(t)?34836:6408,type:n?5126:5121}}({gl:e,floatTargetSupport:n}),r=i.format,a=i.type,o=n?1:1/255;this.setState({textureSize:t,format:r,type:a,weightsScale:o}),n||x.log.warn("HeatmapLayer: ".concat(this.id," rendering to float texture not supported, fallingback to low precession format"))()}},{key:"_createWeightsTransform",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.context.gl,n=this.state.weightsTransform,i=this.state.weightsTexture;n&&n.delete();var r=Object(x._mergeShaders)({vs:gn,_fs:cn,modules:[x.project32]},e);n=new S.Transform(t,fn({id:"".concat(this.id,"-weights-transform"),elementCount:1,_targetTexture:i,_targetTextureVarying:"weightsTexture"},r)),this.setState({weightsTransform:n})}},{key:"_setupResources",value:function(){var e=this.context.gl;this._createTextures();var t=this.state,n=t.textureSize,i=t.weightsTexture,r=t.maxWeightsTexture;this._createWeightsTransform();var a=new S.Transform(e,{id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:i},_targetTexture:r,_targetTextureVarying:"outTexture",vs:"attribute vec4 inTexture;\nvarying vec4 outTexture;\n\nvoid main()\n{\noutTexture = inTexture;\ngl_Position = vec4(0, 0, 0, 1.);\ngl_PointSize = 1.0;\n}\n",elementCount:n*n});this.setState({weightsTexture:i,maxWeightsTexture:r,maxWeightTransform:a,zoom:null,triPositionBuffer:new S.Buffer(e,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new S.Buffer(e,{byteLength:48,accessor:{size:2}})})}},{key:"updateShaders",value:function(e){this._createWeightsTransform(e)}},{key:"_updateMaxWeightValue",value:function(){this.state.maxWeightTransform.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}},{key:"_updateBounds",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.context.viewport,n=[t.unproject([0,0]),t.unproject([t.width,0]),t.unproject([t.width,t.height]),t.unproject([0,t.height])],i=tn(n),r={visibleWorldBounds:i,viewportCorners:n},a=!1;if(e||!this.state.worldBounds||!nn(this.state.worldBounds,i)){var o=this._worldToCommonBounds(i),s=this._commonToWorldBounds(o);this.props.coordinateSystem===x.COORDINATE_SYSTEM.LNGLAT&&(s[1]=Math.max(s[1],-85.051129),s[3]=Math.min(s[3],85.051129),s[0]=Math.max(s[0],-360),s[2]=Math.min(s[2],360));var u=this._worldToCommonBounds(s);r.worldBounds=s,r.normalizedCommonBounds=u,a=!0}return this.setState(r),a}},{key:"_updateTextureRenderingBounds",value:function(){var e=this.state,t=e.triPositionBuffer,n=e.triTexCoordBuffer,i=e.normalizedCommonBounds,r=e.viewportCorners,a=this.context.viewport;t.subData(an(r,3));var o=r.map((function(e){return t=a.projectPosition(e),n=i,r=re()(n,4),o=r[0],s=r[1],u=r[2],l=r[3],[(t[0]-o)/(u-o),(t[1]-s)/(l-s)];var t,n,r,o,s,u,l}));n.subData(an(o,2))}},{key:"_updateColorTexture",value:function(e){var t=e.props.colorRange,n=this.state.colorTexture,i=K(t,!0);n?n.setImageData({data:i,width:t.length}):n=new S.Texture2D(this.context.gl,fn({data:i,width:t.length,height:1,format:Object(S.isWebGL2)(this.context.gl)?34836:6408,type:5126},hn)),this.setState({colorTexture:n})}},{key:"_updateWeightmap",value:function(){var e,t=this.props.radiusPixels,n=this.state,i=n.weightsTransform,r=n.worldBounds,a=n.textureSize,s=n.weightsTexture,u=n.weightsScale,l={radiusPixels:t,commonBounds:this._worldToCommonBounds(r,{useLayerCoordinateSystem:!0}),textureWidth:a,weightsScale:u};i.update({elementCount:this.getNumInstances()}),i.run({uniforms:l,parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0,attributes:this.getAttributes(),moduleSettings:this.getModuleSettings()}),this._updateMaxWeightValue(),s.setParameters((e={},o()(e,10240,9729),o()(e,10241,9729),e)),this.setState({lastUpdate:Date.now()})}},{key:"_debouncedUpdateWeightmap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.state.updateTimer,n=Date.now()-this.state.lastUpdate;e&&(t=null),n>=500?(this._updateBounds(!0),this._updateWeightmap(),this._updateTextureRenderingBounds()):t||(t=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),500-n)),this.setState({updateTimer:t})}},{key:"_worldToCommonBounds",value:function(e){var t,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=i.useLayerCoordinateSystem,a=void 0!==r&&r,o=re()(e,4),s=o[0],u=o[1],l=o[2],g=o[3],c=this.context.viewport,d=this.state.textureSize,f=2*d/c.scale;a?(t=this.projectPosition([s,u,0]),n=this.projectPosition([l,g,0])):(t=c.projectPosition([s,u,0]),n=c.projectPosition([l,g,0]));var h=t.slice(0,2).concat(n.slice(0,2));return h=on(h,f,f)}},{key:"_commonToWorldBounds",value:function(e){var t=re()(e,4),n=t[0],i=t[1],r=t[2],a=t[3],o=this.context.viewport,s=o.unprojectPosition([n,i]),u=o.unprojectPosition([r,a]);return s.slice(0,2).concat(u.slice(0,2))}}]),t}(ne);xn.layerName="HeatmapLayer",xn.defaultProps=vn,n.d(t,"ScreenGridLayer",(function(){return Ee})),n.d(t,"CPUGridLayer",(function(){return Ue})),n.d(t,"HexagonLayer",(function(){return Qe})),n.d(t,"ContourLayer",(function(){return Yt})),n.d(t,"GridLayer",(function(){return en})),n.d(t,"GPUGridLayer",(function(){return Jt})),n.d(t,"AGGREGATION_OPERATION",(function(){return b})),n.d(t,"HeatmapLayer",(function(){return xn})),n.d(t,"_GPUGridAggregator",(function(){return H})),n.d(t,"_CPUAggregator",(function(){return Fe})),n.d(t,"_BinSorter",(function(){return Se}))}])}));