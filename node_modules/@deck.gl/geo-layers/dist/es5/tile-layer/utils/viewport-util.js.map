{"version":3,"sources":["../../../../src/tile-layer/utils/viewport-util.js"],"names":["TILE_SIZE","getBoundingBox","viewport","corners","unproject","width","height","reduce","minLng","p","minLat","maxLng","maxLat","getTileIndex","lngLat","scale","x","y","getTileIndices","maxZoom","minZoom","z","Math","floor","zoom","constructor","Object","assign","bbox","minX","minY","maxX","maxY","max","min","ceil","indices","push","getAdjustedTileIndex","adjustedZ","m","pow"],"mappings":"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","sourcesContent":["import {lngLatToWorld} from '@math.gl/web-mercator';\n\nconst TILE_SIZE = 512;\n\nfunction getBoundingBox(viewport) {\n  const corners = [\n    viewport.unproject([0, 0]),\n    viewport.unproject([viewport.width, 0]),\n    viewport.unproject([0, viewport.height]),\n    viewport.unproject([viewport.width, viewport.height])\n  ];\n\n  return [\n    corners.reduce((minLng, p) => (minLng < p[0] ? minLng : p[0]), 180),\n    corners.reduce((minLat, p) => (minLat < p[1] ? minLat : p[1]), 90),\n    corners.reduce((maxLng, p) => (maxLng > p[0] ? maxLng : p[0]), -180),\n    corners.reduce((maxLat, p) => (maxLat > p[1] ? maxLat : p[1]), -90)\n  ];\n}\n\nfunction getTileIndex(lngLat, scale) {\n  let [x, y] = lngLatToWorld(lngLat);\n  x *= scale / TILE_SIZE;\n  y = (1 - y / TILE_SIZE) * scale;\n  return [x, y];\n}\n\n/**\n * Returns all tile indices in the current viewport. If the current zoom level is smaller\n * than minZoom, return an empty array. If the current zoom level is greater than maxZoom,\n * return tiles that are on maxZoom.\n */\nexport function getTileIndices(viewport, maxZoom, minZoom) {\n  const z = Math.floor(viewport.zoom);\n  if (minZoom && z < minZoom) {\n    return [];\n  }\n\n  viewport = new viewport.constructor(\n    Object.assign({}, viewport, {\n      zoom: z\n    })\n  );\n\n  const bbox = getBoundingBox(viewport);\n\n  let [minX, minY] = getTileIndex([bbox[0], bbox[3]], viewport.scale);\n  let [maxX, maxY] = getTileIndex([bbox[2], bbox[1]], viewport.scale);\n\n  /*\n      |  TILE  |  TILE  |  TILE  |\n        |(minPixel)           |(maxPixel)\n      |(minIndex)                |(maxIndex)  \n   */\n  minX = Math.max(0, Math.floor(minX));\n  maxX = Math.min(viewport.scale, Math.ceil(maxX));\n  minY = Math.max(0, Math.floor(minY));\n  maxY = Math.min(viewport.scale, Math.ceil(maxY));\n\n  const indices = [];\n\n  for (let x = minX; x < maxX; x++) {\n    for (let y = minY; y < maxY; y++) {\n      if (maxZoom && z > maxZoom) {\n        indices.push(getAdjustedTileIndex({x, y, z}, maxZoom));\n      } else {\n        indices.push({x, y, z});\n      }\n    }\n  }\n  return indices;\n}\n\n/**\n * Calculates and returns a new tile index {x, y, z}, with z being the given adjustedZ.\n */\nfunction getAdjustedTileIndex({x, y, z}, adjustedZ) {\n  const m = Math.pow(2, z - adjustedZ);\n  return {\n    x: Math.floor(x / m),\n    y: Math.floor(y / m),\n    z: adjustedZ\n  };\n}\n"],"file":"viewport-util.js"}