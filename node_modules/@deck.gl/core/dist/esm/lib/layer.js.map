{"version":3,"sources":["../../../src/lib/layer.js"],"names":["COORDINATE_SYSTEM","AttributeManager","UniformTransitionManager","diffProps","validateProps","count","log","debug","withParameters","setParameters","assert","mergeShaders","projectPosition","getWorldPosition","typedArrayManager","Component","LayerState","worldToPixels","load","TRACE_CHANGE_FLAG","TRACE_INITIALIZE","TRACE_UPDATE","TRACE_FINALIZE","TRACE_MATCHED","EMPTY_ARRAY","Object","freeze","pickingColorCache","Uint8ClampedArray","defaultProps","data","type","value","async","dataComparator","_dataDiff","__diff","compare","optional","dataTransform","onDataLoad","fetch","url","layer","getLoadOptions","updateTriggers","visible","pickable","opacity","min","max","onHover","onClick","onDragStart","onDrag","onDragEnd","coordinateSystem","DEFAULT","coordinateOrigin","modelMatrix","wrapLongitude","positionFormat","colorFormat","parameters","uniforms","extensions","getPolygonOffset","layerIndex","highlightedObjectIndex","autoHighlight","highlightColor","Layer","className","constructor","layerName","name","props","id","updateObject","setChangeFlags","stateChanged","assign","state","setNeedsRedraw","redraw","internalState","needsRedraw","context","layerManager","setNeedsUpdate","String","needsUpdate","opts","clearRedrawFlags","_getNeedsRedraw","hasUniformTransition","shouldUpdateState","_getUpdateParams","uniformTransitions","active","models","model","attributeManager","loadOptions","xyz","viewport","worldPosition","pixelProjectionMatrix","x","y","z","length","xy","unproject","LNGLAT","CARTESIAN","info","pickingEvent","i","target","color","Uint8Array","i1","i2","i3","index","Error","shaders","extension","getShaders","call","oldProps","changeFlags","propsOrDataChanged","getAttributeManager","dataChanged","Array","isArray","dataRange","invalidateAll","getModels","finalize","clear","draw","mode","object","diffReason","invalidate","changedAttributes","_setModelAttributes","numInstances","getNumInstances","startIndices","getStartIndices","update","transitions","buffers","attributes","ignoreUnknownAttributes","getChangedAttributes","clearChangedFlags","updateAttributes","updateTransition","propsInTransition","create","key","defineProperty","attribute","cacheSize","allocate","size","copy","newCacheSize","pickingColor","encodePickingColor","subarray","excludeAttributes","userData","shaderAttributes","getShaderAttributes","setAttributes","pickingColors","instancePickingColors","colors","decodePickingColor","start","getVertexOffset","end","buffer","subData","offset","updateSubBuffer","startOffset","undefined","_initState","initializeState","propsChanged","viewportChanged","extensionsChanged","_updateState","stateNeedsUpdate","currentProps","_updateUniformTransition","updateParams","gl","updateState","error","_updateModules","isComposite","_renderLayers","_updateAttributes","setInstanceCount","clearChangeFlags","resetOldProps","finalizeState","moduleParameters","_updateAttributeTransition","Math","pow","setModuleParameters","offsets","polygonOffset","flags","updateTriggersChanged","somethingChanged","newProps","invalidateAttribute","transitionsChanged","add","updateModuleSettings","pickingSelectedColor","pickingHighlightColor","Number","isInteger","getOldProps","attributeManagerNeedsRedraw","getNeedsRedraw","stats","timeline","isFinite","_getAttributeManager","addInstanced","noAlloc","calculateInstancePickingColors","get","deprecated","onAsyncPropUpdated","_onAsyncPropUpdated","bind","setAsyncProps","oldLayer"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable react/no-direct-mutation-state */\nimport {COORDINATE_SYSTEM} from './constants';\nimport AttributeManager from './attribute/attribute-manager';\nimport UniformTransitionManager from './uniform-transition-manager';\nimport {diffProps, validateProps} from '../lifecycle/props';\nimport {count} from '../utils/count';\nimport log from '../utils/log';\nimport debug from '../debug';\nimport GL from '@luma.gl/constants';\nimport {withParameters, setParameters} from '@luma.gl/core';\nimport assert from '../utils/assert';\nimport {mergeShaders} from '../utils/shader';\nimport {projectPosition, getWorldPosition} from '../shaderlib/project/project-functions';\nimport typedArrayManager from '../utils/typed-array-manager';\n\nimport Component from '../lifecycle/component';\nimport LayerState from './layer-state';\n\nimport {worldToPixels} from '@math.gl/web-mercator';\n\nimport {load} from '@loaders.gl/core';\n\nconst TRACE_CHANGE_FLAG = 'layer.changeFlag';\nconst TRACE_INITIALIZE = 'layer.initialize';\nconst TRACE_UPDATE = 'layer.update';\nconst TRACE_FINALIZE = 'layer.finalize';\nconst TRACE_MATCHED = 'layer.matched';\n\nconst EMPTY_ARRAY = Object.freeze([]);\n\nlet pickingColorCache = new Uint8ClampedArray(0);\n\nconst defaultProps = {\n  // data: Special handling for null, see below\n  data: {type: 'data', value: EMPTY_ARRAY, async: true},\n  dataComparator: null,\n  _dataDiff: {type: 'function', value: data => data && data.__diff, compare: false, optional: true},\n  dataTransform: {type: 'function', value: null, compare: false, optional: true},\n  onDataLoad: {type: 'function', value: null, compare: false, optional: true},\n  fetch: {\n    type: 'function',\n    value: (url, {layer}) => load(url, layer.getLoadOptions()),\n    compare: false\n  },\n  updateTriggers: {}, // Update triggers: a core change detection mechanism in deck.gl\n\n  visible: true,\n  pickable: false,\n  opacity: {type: 'number', min: 0, max: 1, value: 1},\n\n  onHover: {type: 'function', value: null, compare: false, optional: true},\n  onClick: {type: 'function', value: null, compare: false, optional: true},\n  onDragStart: {type: 'function', value: null, compare: false, optional: true},\n  onDrag: {type: 'function', value: null, compare: false, optional: true},\n  onDragEnd: {type: 'function', value: null, compare: false, optional: true},\n\n  coordinateSystem: COORDINATE_SYSTEM.DEFAULT,\n  coordinateOrigin: {type: 'array', value: [0, 0, 0], compare: true},\n  modelMatrix: {type: 'array', value: null, compare: true, optional: true},\n  wrapLongitude: false,\n  positionFormat: 'XYZ',\n  colorFormat: 'RGBA',\n\n  parameters: {},\n  uniforms: {},\n  extensions: [],\n\n  // Offset depth based on layer index to avoid z-fighting.\n  // Negative values pull layer towards the camera\n  // https://www.opengl.org/archives/resources/faq/technical/polygonoffset.htm\n  getPolygonOffset: {\n    type: 'function',\n    value: ({layerIndex}) => [0, -layerIndex * 100],\n    compare: false\n  },\n\n  // Selection/Highlighting\n  highlightedObjectIndex: null,\n  autoHighlight: false,\n  highlightColor: {type: 'color', value: [0, 0, 128, 128]}\n};\n\nexport default class Layer extends Component {\n  toString() {\n    const className = this.constructor.layerName || this.constructor.name;\n    return `${className}({id: '${this.props.id}'})`;\n  }\n\n  // Public API\n\n  // Updates selected state members and marks the object for redraw\n  setState(updateObject) {\n    this.setChangeFlags({stateChanged: true});\n    Object.assign(this.state, updateObject);\n    this.setNeedsRedraw();\n  }\n\n  // Sets the redraw flag for this layer, will trigger a redraw next animation frame\n  setNeedsRedraw(redraw = true) {\n    if (this.internalState) {\n      this.internalState.needsRedraw = redraw;\n    }\n  }\n\n  // This layer needs a deep update\n  setNeedsUpdate() {\n    this.context.layerManager.setNeedsUpdate(String(this));\n    this.internalState.needsUpdate = true;\n  }\n\n  // Checks state of attributes and model\n  getNeedsRedraw(opts = {clearRedrawFlags: false}) {\n    return this._getNeedsRedraw(opts);\n  }\n\n  // Checks if layer attributes needs updating\n  needsUpdate() {\n    // Call subclass lifecycle method\n    return (\n      this.internalState.needsUpdate ||\n      this.hasUniformTransition() ||\n      this.shouldUpdateState(this._getUpdateParams())\n    );\n    // End lifecycle method\n  }\n\n  hasUniformTransition() {\n    return this.internalState.uniformTransitions.active;\n  }\n\n  // Returns true if the layer is pickable and visible.\n  isPickable() {\n    return this.props.pickable && this.props.visible;\n  }\n\n  // Return an array of models used by this layer, can be overriden by layer subclass\n  getModels() {\n    return this.state && (this.state.models || (this.state.model ? [this.state.model] : []));\n  }\n\n  getAttributeManager() {\n    return this.internalState && this.internalState.attributeManager;\n  }\n\n  // Returns the most recent layer that matched to this state\n  // (When reacting to an async event, this layer may no longer be the latest)\n  getCurrentLayer() {\n    return this.internalState && this.internalState.layer;\n  }\n\n  // Returns the default parse options for async props\n  getLoadOptions() {\n    return this.props.loadOptions;\n  }\n\n  // PROJECTION METHODS\n\n  // Projects a point with current map state (lat, lon, zoom, pitch, bearing)\n  // From the current layer's coordinate system to screen\n  project(xyz) {\n    const {viewport} = this.context;\n    const worldPosition = getWorldPosition(xyz, {\n      viewport,\n      modelMatrix: this.props.modelMatrix,\n      coordinateOrigin: this.props.coordinateOrigin,\n      coordinateSystem: this.props.coordinateSystem\n    });\n    const [x, y, z] = worldToPixels(worldPosition, viewport.pixelProjectionMatrix);\n    return xyz.length === 2 ? [x, y] : [x, y, z];\n  }\n\n  // Note: this does not reverse `project`.\n  // Always unprojects to the viewport's coordinate system\n  unproject(xy) {\n    const {viewport} = this.context;\n    return viewport.unproject(xy);\n  }\n\n  projectPosition(xyz) {\n    return projectPosition(xyz, {\n      viewport: this.context.viewport,\n      modelMatrix: this.props.modelMatrix,\n      coordinateOrigin: this.props.coordinateOrigin,\n      coordinateSystem: this.props.coordinateSystem\n    });\n  }\n\n  use64bitPositions() {\n    const {coordinateSystem} = this.props;\n    return (\n      coordinateSystem === COORDINATE_SYSTEM.DEFAULT ||\n      coordinateSystem === COORDINATE_SYSTEM.LNGLAT ||\n      coordinateSystem === COORDINATE_SYSTEM.CARTESIAN\n    );\n  }\n\n  // Event handling\n  onHover(info, pickingEvent) {\n    if (this.props.onHover) {\n      return this.props.onHover(info, pickingEvent);\n    }\n    return false;\n  }\n\n  onClick(info, pickingEvent) {\n    if (this.props.onClick) {\n      return this.props.onClick(info, pickingEvent);\n    }\n    return false;\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  // @return {Array} - a black color\n  nullPickingColor() {\n    return [0, 0, 0];\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  encodePickingColor(i, target = []) {\n    target[0] = (i + 1) & 255;\n    target[1] = ((i + 1) >> 8) & 255;\n    target[2] = (((i + 1) >> 8) >> 8) & 255;\n    return target;\n  }\n\n  // Returns the index corresponding to a picking color that doesn't match any subfeature\n  // @param {Uint8Array} color - color array to be decoded\n  // @return {Array} - the decoded picking color\n  decodePickingColor(color) {\n    assert(color instanceof Uint8Array);\n    const [i1, i2, i3] = color;\n    // 1 was added to seperate from no selection\n    const index = i1 + i2 * 256 + i3 * 65536 - 1;\n    return index;\n  }\n\n  // //////////////////////////////////////////////////\n  // LIFECYCLE METHODS, overridden by the layer subclasses\n\n  // Called once to set up the initial state\n  // App can create WebGL resources\n  initializeState() {\n    throw new Error(`Layer ${this} has not defined initializeState`);\n  }\n\n  getShaders(shaders) {\n    for (const extension of this.props.extensions) {\n      shaders = mergeShaders(shaders, extension.getShaders.call(this, extension));\n    }\n    return shaders;\n  }\n\n  // Let's layer control if updateState should be called\n  shouldUpdateState({oldProps, props, context, changeFlags}) {\n    return changeFlags.propsOrDataChanged;\n  }\n\n  // Default implementation, all attributes will be invalidated and updated\n  // when data changes\n  /* eslint-disable-next-line complexity */\n  updateState({oldProps, props, context, changeFlags}) {\n    const attributeManager = this.getAttributeManager();\n    if (changeFlags.dataChanged && attributeManager) {\n      const {dataChanged} = changeFlags;\n      if (Array.isArray(dataChanged)) {\n        // is partial update\n        for (const dataRange of dataChanged) {\n          attributeManager.invalidateAll(dataRange);\n        }\n      } else {\n        attributeManager.invalidateAll();\n      }\n    }\n  }\n\n  // Called once when layer is no longer matched and state will be discarded\n  // App can destroy WebGL resources here\n  finalizeState() {\n    for (const model of this.getModels()) {\n      model.delete();\n    }\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.finalize();\n    }\n    this.internalState.uniformTransitions.clear();\n  }\n\n  // If state has a model, draw it with supplied uniforms\n  draw(opts) {\n    for (const model of this.getModels()) {\n      model.draw(opts);\n    }\n  }\n\n  // called to populate the info object that is passed to the event handler\n  // @return null to cancel event\n  getPickingInfo({info, mode}) {\n    const {index} = info;\n\n    if (index >= 0) {\n      // If props.data is an indexable array, get the object\n      if (Array.isArray(this.props.data)) {\n        info.object = this.props.data[index];\n      }\n    }\n\n    return info;\n  }\n\n  // END LIFECYCLE METHODS\n  // //////////////////////////////////////////////////\n\n  // INTERNAL METHODS\n\n  // Default implementation of attribute invalidation, can be redefined\n  invalidateAttribute(name = 'all', diffReason = '') {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    if (name === 'all') {\n      attributeManager.invalidateAll();\n    } else {\n      attributeManager.invalidate(name);\n    }\n  }\n\n  updateAttributes(changedAttributes) {\n    for (const model of this.getModels()) {\n      this._setModelAttributes(model, changedAttributes);\n    }\n  }\n\n  // Calls attribute manager to update any WebGL attributes\n  _updateAttributes(props) {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    // Figure out data length\n    const numInstances = this.getNumInstances(props);\n    const startIndices = this.getStartIndices(props);\n\n    attributeManager.update({\n      data: props.data,\n      numInstances,\n      startIndices,\n      props,\n      transitions: props.transitions,\n      buffers: props.data.attributes,\n      context: this,\n      // Don't worry about non-attribute props\n      ignoreUnknownAttributes: true\n    });\n\n    const changedAttributes = attributeManager.getChangedAttributes({clearChangedFlags: true});\n    this.updateAttributes(changedAttributes);\n  }\n\n  // Update attribute transitions. This is called in drawLayer, no model updates required.\n  _updateAttributeTransition() {\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.updateTransition();\n    }\n  }\n\n  // Update uniform (prop) transitions. This is called in updateState, may result in model updates.\n  _updateUniformTransition() {\n    const {uniformTransitions} = this.internalState;\n    if (uniformTransitions.active) {\n      // clone props\n      const propsInTransition = uniformTransitions.update();\n      const props = Object.create(this.props);\n      for (const key in propsInTransition) {\n        Object.defineProperty(props, key, {value: propsInTransition[key]});\n      }\n      return props;\n    }\n    return this.props;\n  }\n\n  calculateInstancePickingColors(attribute, {numInstances}) {\n    // calculateInstancePickingColors always generates the same sequence.\n    // pickingColorCache saves the largest generated sequence for reuse\n    const cacheSize = pickingColorCache.length / 3;\n\n    if (cacheSize < numInstances) {\n      pickingColorCache = typedArrayManager.allocate(pickingColorCache, numInstances, {\n        size: 3,\n        copy: true\n      });\n      // If the attribute is larger than the cache, resize the cache and populate the missing chunk\n      const newCacheSize = pickingColorCache.length / 3;\n      const pickingColor = [];\n      assert(newCacheSize < 16777215, 'index out of picking color range');\n\n      for (let i = cacheSize; i < newCacheSize; i++) {\n        this.encodePickingColor(i, pickingColor);\n        pickingColorCache[i * 3 + 0] = pickingColor[0];\n        pickingColorCache[i * 3 + 1] = pickingColor[1];\n        pickingColorCache[i * 3 + 2] = pickingColor[2];\n      }\n    }\n\n    attribute.value = pickingColorCache.subarray(0, numInstances * 3);\n  }\n\n  _setModelAttributes(model, changedAttributes) {\n    const attributeManager = this.getAttributeManager();\n    const excludeAttributes = model.userData.excludeAttributes || {};\n    const shaderAttributes = attributeManager.getShaderAttributes(\n      changedAttributes,\n      excludeAttributes\n    );\n\n    model.setAttributes(shaderAttributes);\n  }\n\n  // Sets the specified instanced picking color to null picking color. Used for multi picking.\n  clearPickingColor(color) {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n\n    const i = this.decodePickingColor(color);\n    const start = colors.getVertexOffset(i);\n    const end = colors.getVertexOffset(i + 1);\n\n    // Fill the sub buffer with 0s\n    colors.buffer.subData({\n      data: new Uint8Array(end - start),\n      offset: start // 1 byte per element\n    });\n  }\n\n  restorePickingColors() {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n    colors.updateSubBuffer({startOffset: 0});\n  }\n\n  // Deduces numer of instances. Intention is to support:\n  // - Explicit setting of numInstances\n  // - Auto-deduction for ES6 containers that define a size member\n  // - Auto-deduction for Classic Arrays via the built-in length attribute\n  // - Auto-deduction via arrays\n  getNumInstances(props) {\n    props = props || this.props;\n\n    // First Check if app has provided an explicit value\n    if (props.numInstances !== undefined) {\n      return props.numInstances;\n    }\n\n    // Second check if the layer has set its own value\n    if (this.state && this.state.numInstances !== undefined) {\n      return this.state.numInstances;\n    }\n\n    // Use container library to get a count for any ES6 container or object\n    return count(props.data);\n  }\n\n  // Buffer layout describes how many attribute values are packed for each data object\n  // The default (null) is one value each object.\n  // Some data formats (e.g. paths, polygons) have various length. Their buffer layout\n  //  is in the form of [L0, L1, L2, ...]\n  getStartIndices(props) {\n    props = props || this.props;\n\n    // First Check if startIndices is provided as an explicit value\n    if (props.startIndices !== undefined) {\n      return props.startIndices;\n    }\n\n    // Second check if the layer has set its own value\n    if (this.state && this.state.startIndices) {\n      return this.state.startIndices;\n    }\n\n    return null;\n  }\n\n  // LAYER MANAGER API\n  // Should only be called by the deck.gl LayerManager class\n\n  // Called by layer manager when a new layer is found\n  /* eslint-disable max-statements */\n  _initialize() {\n    debug(TRACE_INITIALIZE, this);\n\n    this._initState();\n\n    // Call subclass lifecycle methods\n    this.initializeState(this.context);\n    // Initialize extensions\n    for (const extension of this.props.extensions) {\n      extension.initializeState.call(this, this.context, extension);\n    }\n    // End subclass lifecycle methods\n\n    // initializeState callback tends to clear state\n    this.setChangeFlags({\n      dataChanged: true,\n      propsChanged: true,\n      viewportChanged: true,\n      extensionsChanged: true\n    });\n\n    this._updateState();\n  }\n\n  // Called by layer manager\n  // if this layer is new (not matched with an existing layer) oldProps will be empty object\n  _update() {\n    // Call subclass lifecycle method\n    const stateNeedsUpdate = this.needsUpdate();\n    // End lifecycle method\n    debug(TRACE_UPDATE, this, stateNeedsUpdate);\n\n    if (stateNeedsUpdate) {\n      this._updateState();\n    }\n  }\n  /* eslint-enable max-statements */\n\n  // Common code for _initialize and _update\n  _updateState() {\n    const currentProps = this.props;\n    const propsInTransition = this._updateUniformTransition();\n    this.internalState.propsInTransition = propsInTransition;\n    // Overwrite this.props during update to use in-transition prop values\n    this.props = propsInTransition;\n\n    const updateParams = this._getUpdateParams();\n\n    // Safely call subclass lifecycle methods\n    if (this.context.gl) {\n      this.updateState(updateParams);\n    } else {\n      try {\n        this.updateState(updateParams);\n      } catch (error) {\n        // ignore error if gl context is missing\n      }\n    }\n    // Execute extension updates\n    for (const extension of this.props.extensions) {\n      extension.updateState.call(this, updateParams, extension);\n    }\n    this._updateModules(updateParams);\n    // End subclass lifecycle methods\n\n    if (this.isComposite) {\n      // Render or update previously rendered sublayers\n      this._renderLayers(updateParams);\n    } else {\n      this.setNeedsRedraw();\n      // Add any subclass attributes\n      this._updateAttributes(this.props);\n\n      // Note: Automatic instance count update only works for single layers\n      if (this.state.model) {\n        this.state.model.setInstanceCount(this.getNumInstances());\n      }\n    }\n\n    this.props = currentProps;\n    this.clearChangeFlags();\n    this.internalState.needsUpdate = false;\n    this.internalState.resetOldProps();\n  }\n\n  // Called by manager when layer is about to be disposed\n  // Note: not guaranteed to be called on application shutdown\n  _finalize() {\n    debug(TRACE_FINALIZE, this);\n    assert(this.internalState && this.state);\n\n    // Call subclass lifecycle method\n    this.finalizeState(this.context);\n    // Finalize extensions\n    for (const extension of this.props.extensions) {\n      extension.finalizeState.call(this, extension);\n    }\n  }\n\n  // Calculates uniforms\n  drawLayer({moduleParameters = null, uniforms = {}, parameters = {}}) {\n    this._updateAttributeTransition();\n\n    const currentProps = this.props;\n    // Overwrite this.props during redraw to use in-transition prop values\n    this.props = this.internalState.propsInTransition;\n\n    const {opacity} = this.props;\n    // apply gamma to opacity to make it visually \"linear\"\n    uniforms.opacity = Math.pow(opacity, 1 / 2.2);\n\n    // TODO/ib - hack move to luma Model.draw\n    if (moduleParameters) {\n      this.setModuleParameters(moduleParameters);\n    }\n\n    // Apply polygon offset to avoid z-fighting\n    // TODO - move to draw-layers\n    const {getPolygonOffset} = this.props;\n    const offsets = (getPolygonOffset && getPolygonOffset(uniforms)) || [0, 0];\n\n    setParameters(this.context.gl, {polygonOffset: offsets});\n\n    // Call subclass lifecycle method\n    withParameters(this.context.gl, parameters, () => {\n      this.draw({moduleParameters, uniforms, parameters, context: this.context});\n    });\n\n    // End lifecycle method\n\n    this.props = currentProps;\n  }\n\n  // Helper methods\n  getChangeFlags() {\n    return this.internalState.changeFlags;\n  }\n\n  // Dirty some change flags, will be handled by updateLayer\n  /* eslint-disable complexity */\n  setChangeFlags(flags) {\n    const {changeFlags} = this.internalState;\n\n    for (const key in changeFlags) {\n      if (flags[key] && !changeFlags[key]) {\n        changeFlags[key] = flags[key];\n        debug(TRACE_CHANGE_FLAG, this, key, flags);\n      }\n    }\n\n    // Update composite flags\n    const propsOrDataChanged =\n      changeFlags.dataChanged ||\n      changeFlags.updateTriggersChanged ||\n      changeFlags.propsChanged ||\n      changeFlags.extensionsChanged;\n    changeFlags.propsOrDataChanged = propsOrDataChanged;\n    changeFlags.somethingChanged =\n      propsOrDataChanged || flags.viewportChanged || flags.stateChanged;\n  }\n  /* eslint-enable complexity */\n\n  // Clear all changeFlags, typically after an update\n  clearChangeFlags() {\n    this.internalState.changeFlags = {\n      // Primary changeFlags, can be strings stating reason for change\n      dataChanged: false,\n      propsChanged: false,\n      updateTriggersChanged: false,\n      viewportChanged: false,\n      stateChanged: false,\n      extensionsChanged: false,\n\n      // Derived changeFlags\n      propsOrDataChanged: false,\n      somethingChanged: false\n    };\n  }\n\n  // Compares the layers props with old props from a matched older layer\n  // and extracts change flags that describe what has change so that state\n  // can be update correctly with minimal effort\n  diffProps(newProps, oldProps) {\n    const changeFlags = diffProps(newProps, oldProps);\n\n    // iterate over changedTriggers\n    if (changeFlags.updateTriggersChanged) {\n      for (const key in changeFlags.updateTriggersChanged) {\n        if (changeFlags.updateTriggersChanged[key]) {\n          this.invalidateAttribute(key);\n        }\n      }\n    }\n\n    // trigger uniform transitions\n    if (changeFlags.transitionsChanged) {\n      for (const key in changeFlags.transitionsChanged) {\n        // prop changed and transition is enabled\n        this.internalState.uniformTransitions.add(\n          key,\n          oldProps[key],\n          newProps[key],\n          newProps.transitions[key]\n        );\n      }\n    }\n\n    return this.setChangeFlags(changeFlags);\n  }\n\n  // Called by layer manager to validate props (in development)\n  validateProps() {\n    validateProps(this.props);\n  }\n\n  setModuleParameters(moduleParameters) {\n    for (const model of this.getModels()) {\n      model.updateModuleSettings(moduleParameters);\n    }\n  }\n\n  // PRIVATE METHODS\n  _updateModules({props, oldProps}) {\n    // Picking module parameters\n    const {autoHighlight, highlightedObjectIndex, highlightColor} = props;\n    if (\n      oldProps.autoHighlight !== autoHighlight ||\n      oldProps.highlightedObjectIndex !== highlightedObjectIndex ||\n      oldProps.highlightColor !== highlightColor\n    ) {\n      const parameters = {};\n      if (!autoHighlight) {\n        parameters.pickingSelectedColor = null;\n      }\n      // TODO - fix in luma?\n      highlightColor[3] = highlightColor[3] || 255;\n      parameters.pickingHighlightColor = highlightColor;\n\n      // highlightedObjectIndex will overwrite any settings from auto highlighting.\n      if (Number.isInteger(highlightedObjectIndex)) {\n        parameters.pickingSelectedColor =\n          highlightedObjectIndex >= 0 ? this.encodePickingColor(highlightedObjectIndex) : null;\n      }\n\n      this.setModuleParameters(parameters);\n    }\n  }\n\n  _getUpdateParams() {\n    return {\n      props: this.props,\n      oldProps: this.internalState.getOldProps(),\n      context: this.context,\n      changeFlags: this.internalState.changeFlags\n    };\n  }\n\n  // Checks state of attributes and model\n  _getNeedsRedraw(opts) {\n    // this method may be called by the render loop as soon a the layer\n    // has been created, so guard against uninitialized state\n    if (!this.internalState) {\n      return false;\n    }\n\n    let redraw = false;\n    redraw = redraw || (this.internalState.needsRedraw && this.id);\n    this.internalState.needsRedraw = this.internalState.needsRedraw && !opts.clearRedrawFlags;\n\n    // TODO - is attribute manager needed? - Model should be enough.\n    const attributeManager = this.getAttributeManager();\n    const attributeManagerNeedsRedraw = attributeManager && attributeManager.getNeedsRedraw(opts);\n    redraw = redraw || attributeManagerNeedsRedraw;\n\n    return redraw;\n  }\n\n  // Create new attribute manager\n  _getAttributeManager() {\n    return new AttributeManager(this.context.gl, {\n      id: this.props.id,\n      stats: this.context.stats,\n      timeline: this.context.timeline\n    });\n  }\n\n  _initState() {\n    assert(!this.internalState && !this.state);\n    assert(isFinite(this.props.coordinateSystem), `${this.id}: invalid coordinateSystem`);\n\n    const attributeManager = this._getAttributeManager();\n\n    if (attributeManager) {\n      // All instanced layers get instancePickingColors attribute by default\n      // Their shaders can use it to render a picking scene\n      // TODO - this slightly slows down non instanced layers\n      attributeManager.addInstanced({\n        instancePickingColors: {\n          type: GL.UNSIGNED_BYTE,\n          size: 3,\n          noAlloc: true,\n          update: this.calculateInstancePickingColors\n        }\n      });\n    }\n\n    this.internalState = new LayerState({\n      attributeManager,\n      layer: this\n    });\n    this.clearChangeFlags(); // populate this.internalState.changeFlags\n\n    this.state = {};\n    // for backwards compatibility with older layers\n    // TODO - remove in next release\n    /* eslint-disable accessor-pairs */\n    Object.defineProperty(this.state, 'attributeManager', {\n      get: () => {\n        log.deprecated('layer.state.attributeManager', 'layer.getAttributeManager()');\n        return attributeManager;\n      }\n    });\n    /* eslint-enable accessor-pairs */\n\n    this.internalState.layer = this;\n    this.internalState.uniformTransitions = new UniformTransitionManager(this.context.timeline);\n    this.internalState.onAsyncPropUpdated = this._onAsyncPropUpdated.bind(this);\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n  }\n\n  // Called by layer manager to transfer state from an old layer\n  _transferState(oldLayer) {\n    debug(TRACE_MATCHED, this, this === oldLayer);\n\n    const {state, internalState} = oldLayer;\n    assert(state && internalState);\n\n    if (this === oldLayer) {\n      return;\n    }\n\n    // Move internalState\n    this.internalState = internalState;\n    this.internalState.layer = this;\n\n    // Move state\n    this.state = state;\n    // We keep the state ref on old layers to support async actions\n    // oldLayer.state = null;\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n\n    this.diffProps(this.props, this.internalState.getOldProps());\n  }\n\n  _onAsyncPropUpdated() {\n    this.diffProps(this.props, this.internalState.getOldProps());\n    this.setNeedsUpdate();\n  }\n}\n\nLayer.layerName = 'Layer';\nLayer.defaultProps = defaultProps;\n"],"file":"layer.js"}