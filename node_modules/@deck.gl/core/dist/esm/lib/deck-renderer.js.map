{"version":3,"sources":["../../../src/lib/deck-renderer.js"],"names":["debug","DrawLayersPass","PickLayersPass","Framebuffer","TRACE_RENDER_LAYERS","DeckRenderer","gl","layerFilter","drawPickingColors","drawLayersPass","pickLayersPass","renderCount","_needsRedraw","renderBuffers","lastPostProcessEffect","props","opts","layerPass","effects","target","getDefaultFramebuffer","_preRender","outputBuffer","renderStats","render","_postRender","clearRedrawFlags","redraw","buffer","length","effect","preRender","postRender","_resizeRenderBuffers","push","resize","params","inputBuffer","swapBuffer"],"mappings":"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","sourcesContent":["import debug from '../debug';\nimport DrawLayersPass from '../passes/draw-layers-pass';\nimport PickLayersPass from '../passes/pick-layers-pass';\nimport {Framebuffer} from '@luma.gl/core';\n\nconst TRACE_RENDER_LAYERS = 'deckRenderer.renderLayers';\n\nexport default class DeckRenderer {\n  constructor(gl) {\n    this.gl = gl;\n    this.layerFilter = null;\n    this.drawPickingColors = false;\n    this.drawLayersPass = new DrawLayersPass(gl);\n    this.pickLayersPass = new PickLayersPass(gl);\n    this.renderCount = 0;\n    this._needsRedraw = 'Initial render';\n    this.renderBuffers = [];\n    this.lastPostProcessEffect = null;\n  }\n\n  setProps(props) {\n    if ('layerFilter' in props && this.layerFilter !== props.layerFilter) {\n      this.layerFilter = props.layerFilter;\n      this._needsRedraw = 'layerFilter changed';\n    }\n\n    if ('drawPickingColors' in props && this.drawPickingColors !== props.drawPickingColors) {\n      this.drawPickingColors = props.drawPickingColors;\n      this._needsRedraw = 'drawPickingColors changed';\n    }\n  }\n\n  /*\n    target,\n    layers,\n    viewports,\n    onViewportActive,\n    views,\n    redrawReason,\n    clearCanvas,\n    effects,\n    pass,\n    stats\n  */\n  renderLayers(opts) {\n    const layerPass = this.drawPickingColors ? this.pickLayersPass : this.drawLayersPass;\n\n    opts.layerFilter = this.layerFilter;\n    opts.effects = opts.effects || [];\n    opts.target = opts.target || Framebuffer.getDefaultFramebuffer(this.gl);\n\n    this._preRender(opts.effects, opts);\n\n    const outputBuffer = this.lastPostProcessEffect ? this.renderBuffers[0] : opts.target;\n    const renderStats = layerPass.render({...opts, target: outputBuffer});\n\n    this._postRender(opts.effects, opts);\n\n    this.renderCount++;\n\n    debug(TRACE_RENDER_LAYERS, this, renderStats, opts);\n  }\n\n  needsRedraw(opts = {clearRedrawFlags: false}) {\n    const redraw = this._needsRedraw;\n    if (opts.clearRedrawFlags) {\n      this._needsRedraw = false;\n    }\n    return redraw;\n  }\n\n  finalize() {\n    const {renderBuffers} = this;\n    for (const buffer of renderBuffers) {\n      buffer.delete();\n    }\n    renderBuffers.length = 0;\n  }\n\n  // Private\n  _preRender(effects, opts) {\n    let lastPostProcessEffect = null;\n\n    for (const effect of effects) {\n      effect.preRender(this.gl, opts);\n      if (effect.postRender) {\n        lastPostProcessEffect = effect;\n      }\n    }\n\n    if (lastPostProcessEffect) {\n      this._resizeRenderBuffers();\n    }\n    this.lastPostProcessEffect = lastPostProcessEffect;\n  }\n\n  _resizeRenderBuffers() {\n    const {renderBuffers} = this;\n    if (renderBuffers.length === 0) {\n      renderBuffers.push(new Framebuffer(this.gl), new Framebuffer(this.gl));\n    }\n    for (const buffer of renderBuffers) {\n      buffer.resize();\n    }\n  }\n\n  _postRender(effects, opts) {\n    const {renderBuffers} = this;\n    const params = {\n      inputBuffer: renderBuffers[0],\n      swapBuffer: renderBuffers[1],\n      target: null\n    };\n    for (const effect of effects) {\n      if (effect.postRender) {\n        if (effect === this.lastPostProcessEffect) {\n          params.target = opts.target;\n          effect.postRender(this.gl, params);\n          break;\n        }\n        const buffer = effect.postRender(this.gl, params);\n        params.inputBuffer = buffer;\n        params.swapBuffer = buffer === renderBuffers[0] ? renderBuffers[1] : renderBuffers[0];\n      }\n    }\n  }\n}\n"],"file":"deck-renderer.js"}